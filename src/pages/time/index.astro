---
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import timeEntries from '../../data/time-entries.json';
import tasks from '../../data/tasks.json';
import projects from '../../data/projects.json';

const projectMap = Object.fromEntries(projects.map((p) => [p.id, p]));
const taskMap = Object.fromEntries(tasks.map((t) => [t.id, t]));

// Helper: format minutes to "Xh Ym"
function formatDuration(minutes: number): string {
  const h = Math.floor(minutes / 60);
  const m = minutes % 60;
  if (h === 0) return `${m}m`;
  if (m === 0) return `${h}h`;
  return `${h}h ${m}m`;
}

// Reference date for the demo
const now = new Date('2026-02-06T18:00:00Z');
const todayStr = '2026-02-06';

// --- Today's entries ---
const todayEntries = timeEntries.filter((e) => e.startTime.startsWith(todayStr));
const todayMinutes = todayEntries.reduce((sum, e) => sum + e.durationMinutes, 0);

// --- This week (Mon-Sun containing "today") ---
const todayDate = new Date(todayStr);
const dayOfWeek = todayDate.getDay(); // 0=Sun ... 6=Sat
const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
const weekStart = new Date(todayDate);
weekStart.setDate(todayDate.getDate() + mondayOffset);
const weekEnd = new Date(weekStart);
weekEnd.setDate(weekStart.getDate() + 6);

function dateInRange(dateStr: string, start: Date, end: Date): boolean {
  const d = new Date(dateStr.slice(0, 10));
  return d >= start && d <= end;
}

const weekEntries = timeEntries.filter((e) => dateInRange(e.startTime, weekStart, weekEnd));
const weekMinutes = weekEntries.reduce((sum, e) => sum + e.durationMinutes, 0);

// --- Per-project breakdown (this week) ---
interface ProjectTime {
  id: string;
  title: string;
  color: string;
  minutes: number;
  percentage: number;
}

const projectTimeMap = new Map<string, number>();
weekEntries.forEach((e) => {
  const pid = e.projectId || 'personal';
  projectTimeMap.set(pid, (projectTimeMap.get(pid) || 0) + e.durationMinutes);
});

const projectBreakdown: ProjectTime[] = Array.from(projectTimeMap.entries())
  .map(([pid, minutes]) => {
    const proj = projectMap[pid];
    return {
      id: pid,
      title: proj ? proj.title : 'Personal',
      color: proj ? proj.color : '#94a3b8',
      minutes,
      percentage: weekMinutes > 0 ? Math.round((minutes / weekMinutes) * 100) : 0,
    };
  })
  .sort((a, b) => b.minutes - a.minutes);

// --- Daily breakdown for the week (bar chart data) ---
const dayLabels: string[] = [];
const dayMinutes: number[] = [];
for (let i = 0; i < 7; i++) {
  const d = new Date(weekStart);
  d.setDate(weekStart.getDate() + i);
  const dateStr = d.toISOString().slice(0, 10);
  const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  dayLabels.push(dayNames[d.getDay()]);
  const mins = timeEntries
    .filter((e) => e.startTime.startsWith(dateStr))
    .reduce((sum, e) => sum + e.durationMinutes, 0);
  dayMinutes.push(mins);
}

// --- Recent entries (sorted by start time, newest first) ---
const recentEntries = [...timeEntries]
  .sort((a, b) => new Date(b.startTime).getTime() - new Date(a.startTime).getTime())
  .slice(0, 15)
  .map((e) => {
    const task = taskMap[e.taskId];
    const proj = e.projectId ? projectMap[e.projectId] : null;
    const start = new Date(e.startTime);
    const dateStr = start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    const timeStr = start.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
    return {
      ...e,
      taskTitle: task ? task.title : 'Unknown task',
      projectTitle: proj ? proj.title : 'Personal',
      projectColor: proj ? proj.color : '#94a3b8',
      dateStr,
      timeStr,
      durationFormatted: formatDuration(e.durationMinutes),
    };
  });

// Average daily hours this week (only days that have passed)
const daysElapsed = dayOfWeek === 0 ? 7 : dayOfWeek === 1 ? 1 : dayOfWeek;
const avgDailyMinutes = daysElapsed > 0 ? Math.round(weekMinutes / daysElapsed) : 0;
---

<DashboardLayout title="Time Tracking" active="time">
  <!-- Page Header -->
  <div class="mb-8 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
    <div>
      <h1 class="text-2xl font-bold tracking-tight text-surface-100">Time Tracking</h1>
      <p class="mt-1 text-sm text-surface-400">Track time across tasks and projects. Week of {weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - {weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}.</p>
    </div>
    <button
      id="manual-entry-btn"
      class="inline-flex items-center gap-2 rounded-lg bg-gradient-to-r from-accent-600 to-accent-700 px-4 py-2.5 text-sm font-medium text-white shadow-lg shadow-accent-600/20 transition-all hover:shadow-accent-600/30 hover:brightness-110"
    >
      <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
      </svg>
      Log Time
    </button>
  </div>

  <!-- Stat Cards -->
  <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 xl:grid-cols-4">
    <!-- Today -->
    <div class="group card p-5 transition-all duration-200 hover:border-accent-500/30">
      <div class="flex items-center justify-between">
        <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-accent-600/15 ring-1 ring-accent-500/10">
          <svg class="h-5 w-5 text-accent-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
          </svg>
        </div>
        <span class="inline-flex items-center gap-1 rounded-full bg-accent-500/10 px-2 py-0.5 text-[11px] font-medium text-accent-400">
          <span class="h-1.5 w-1.5 rounded-full bg-accent-400 pulse-dot"></span>
          {todayEntries.length} entries
        </span>
      </div>
      <div class="mt-4">
        <p class="text-3xl font-bold tracking-tight text-surface-100">{formatDuration(todayMinutes)}</p>
        <p class="mt-1 text-sm text-surface-400">Today</p>
      </div>
    </div>

    <!-- This Week -->
    <div class="group card p-5 transition-all duration-200 hover:border-green-500/30">
      <div class="flex items-center justify-between">
        <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-green-500/15 ring-1 ring-green-500/10">
          <svg class="h-5 w-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5" />
          </svg>
        </div>
        <span class="inline-flex items-center gap-1 rounded-full bg-green-500/10 px-2 py-0.5 text-[11px] font-medium text-green-400">
          {weekEntries.length} entries
        </span>
      </div>
      <div class="mt-4">
        <p class="text-3xl font-bold tracking-tight text-surface-100">{formatDuration(weekMinutes)}</p>
        <p class="mt-1 text-sm text-surface-400">This Week</p>
      </div>
    </div>

    <!-- Daily Average -->
    <div class="group card p-5 transition-all duration-200 hover:border-amber-500/30">
      <div class="flex items-center justify-between">
        <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-amber-500/15 ring-1 ring-amber-500/10">
          <svg class="h-5 w-5 text-amber-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" />
          </svg>
        </div>
      </div>
      <div class="mt-4">
        <p class="text-3xl font-bold tracking-tight text-surface-100">{formatDuration(avgDailyMinutes)}</p>
        <p class="mt-1 text-sm text-surface-400">Daily Average</p>
      </div>
    </div>

    <!-- Active Timer -->
    <div class="group card p-5 transition-all duration-200 hover:border-blue-500/30">
      <div class="flex items-center justify-between">
        <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-blue-500/15 ring-1 ring-blue-500/10">
          <svg class="h-5 w-5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.347a1.125 1.125 0 0 1 0 1.972l-11.54 6.347a1.125 1.125 0 0 1-1.667-.986V5.653Z" />
          </svg>
        </div>
        <span id="timer-status-badge" class="inline-flex items-center gap-1 rounded-full bg-surface-700/50 px-2 py-0.5 text-[11px] font-medium text-surface-400">
          No active timer
        </span>
      </div>
      <div class="mt-4">
        <p id="active-timer-display" class="text-3xl font-bold tracking-tight text-surface-100">0h 0m</p>
        <p class="mt-1 text-sm text-surface-400">Active Timer</p>
      </div>
    </div>
  </div>

  <!-- Weekly Chart + Project Breakdown -->
  <div class="mt-6 grid grid-cols-1 gap-6 xl:grid-cols-3">
    <!-- Daily Hours Chart -->
    <div class="card p-5 sm:p-6 xl:col-span-2">
      <div class="mb-5 flex items-center justify-between">
        <div>
          <h2 class="text-lg font-semibold text-surface-100">Daily Hours</h2>
          <p class="mt-0.5 text-sm text-surface-400">Time logged per day this week</p>
        </div>
      </div>
      <div class="relative h-64 sm:h-72">
        <canvas
          id="weeklyTimeChart"
          data-labels={JSON.stringify(dayLabels)}
          data-minutes={JSON.stringify(dayMinutes)}
        ></canvas>
      </div>
    </div>

    <!-- Project Breakdown -->
    <div class="card p-5 sm:p-6">
      <div class="mb-5">
        <h2 class="text-lg font-semibold text-surface-100">By Project</h2>
        <p class="mt-0.5 text-sm text-surface-400">Time distribution this week</p>
      </div>
      <div class="space-y-4">
        {projectBreakdown.map((proj) => (
          <div>
            <div class="mb-1.5 flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="h-2.5 w-2.5 rounded-full" style={`background-color: ${proj.color}`}></span>
                <span class="text-sm font-medium text-surface-200">{proj.title}</span>
              </div>
              <span class="text-sm font-medium text-surface-300">{formatDuration(proj.minutes)}</span>
            </div>
            <div class="h-2 w-full overflow-hidden rounded-full bg-surface-700/60">
              <div
                class="h-full rounded-full transition-all duration-500"
                style={`width: ${proj.percentage}%; background-color: ${proj.color}`}
              />
            </div>
            <p class="mt-1 text-right text-xs text-surface-500">{proj.percentage}%</p>
          </div>
        ))}
      </div>

      <!-- Total -->
      <div class="mt-6 border-t border-surface-700/50 pt-4">
        <div class="flex items-center justify-between">
          <span class="text-sm font-semibold text-surface-200">Total This Week</span>
          <span class="text-lg font-bold text-surface-100">{formatDuration(weekMinutes)}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Manual Time Entry Form (hidden by default) -->
  <div id="manual-entry-form" class="mt-6 hidden card p-5">
    <h3 class="mb-4 text-sm font-semibold text-surface-200">Log Time Entry</h3>
    <form id="time-entry-form" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-5">
      <div class="lg:col-span-2">
        <label class="mb-1 block text-xs font-medium text-surface-400">Task</label>
        <select
          id="te-task-input"
          class="w-full rounded-lg border border-surface-700/60 bg-surface-800/40 px-3 py-2 text-sm text-surface-200 transition-all focus:border-accent-500/60 focus:bg-surface-800/60 focus:outline-none focus:ring-1 focus:ring-accent-500/40"
        >
          {tasks.filter(t => t.status !== 'done').map((t) => (
            <option value={t.id}>{t.title}</option>
          ))}
        </select>
      </div>
      <div>
        <label class="mb-1 block text-xs font-medium text-surface-400">Hours</label>
        <input
          type="number"
          id="te-hours-input"
          min="0"
          max="24"
          value="1"
          class="w-full rounded-lg border border-surface-700/60 bg-surface-800/40 px-3 py-2 text-sm text-surface-200 transition-all focus:border-accent-500/60 focus:bg-surface-800/60 focus:outline-none focus:ring-1 focus:ring-accent-500/40"
        />
      </div>
      <div>
        <label class="mb-1 block text-xs font-medium text-surface-400">Minutes</label>
        <input
          type="number"
          id="te-minutes-input"
          min="0"
          max="59"
          value="0"
          class="w-full rounded-lg border border-surface-700/60 bg-surface-800/40 px-3 py-2 text-sm text-surface-200 transition-all focus:border-accent-500/60 focus:bg-surface-800/60 focus:outline-none focus:ring-1 focus:ring-accent-500/40"
        />
      </div>
      <div class="flex items-end gap-2">
        <button
          type="submit"
          class="rounded-lg bg-accent-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-accent-700"
        >
          Log
        </button>
        <button
          type="button"
          id="cancel-entry-btn"
          class="rounded-lg border border-surface-700 px-4 py-2 text-sm font-medium text-surface-400 transition-colors hover:bg-surface-800 hover:text-surface-200"
        >
          Cancel
        </button>
      </div>
    </form>
  </div>

  <!-- Recent Time Entries -->
  <div class="mt-6 card p-5 sm:p-6 pb-16 lg:pb-6">
    <div class="mb-5 flex items-center justify-between">
      <div>
        <h2 class="text-lg font-semibold text-surface-100">Recent Entries</h2>
        <p class="mt-0.5 text-sm text-surface-400">Latest time logged across all projects</p>
      </div>
    </div>

    <div id="time-entries-list" class="space-y-2">
      {recentEntries.map((entry) => (
        <div class="time-entry-item group flex items-center gap-3 rounded-xl border border-surface-700/50 bg-surface-900/80 p-4 transition-all duration-200 hover:border-surface-600 hover:bg-surface-900" data-task-id={entry.taskId} data-project-id={entry.projectId || 'personal'}>
          <!-- Timer/Manual icon -->
          <div class:list={[
            'flex h-8 w-8 flex-shrink-0 items-center justify-center rounded-lg',
            entry.manual ? 'bg-amber-500/15' : 'bg-accent-600/15',
          ]}>
            {entry.manual ? (
              <svg class="h-4 w-4 text-amber-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
              </svg>
            ) : (
              <svg class="h-4 w-4 text-accent-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
              </svg>
            )}
          </div>

          <!-- Details -->
          <div class="flex-1 min-w-0">
            <p class="truncate text-sm font-medium text-surface-200">{entry.description || entry.taskTitle}</p>
            <div class="mt-0.5 flex items-center gap-2 text-xs text-surface-500">
              <span class="flex items-center gap-1">
                <span class="h-1.5 w-1.5 rounded-full" style={`background-color: ${entry.projectColor}`}></span>
                {entry.projectTitle}
              </span>
              <span class="text-surface-700">|</span>
              <span>{entry.taskTitle}</span>
            </div>
          </div>

          <!-- Date/Time -->
          <div class="hidden flex-shrink-0 text-right sm:block">
            <p class="text-xs font-medium text-surface-300">{entry.dateStr}</p>
            <p class="text-xs text-surface-500">{entry.timeStr}</p>
          </div>

          <!-- Duration -->
          <div class="flex-shrink-0 rounded-lg bg-surface-800/80 px-3 py-1.5">
            <p class="text-sm font-semibold text-surface-200">{entry.durationFormatted}</p>
          </div>
        </div>
      ))}
    </div>
  </div>
</DashboardLayout>

<script>
  import { Chart, BarController, CategoryScale, LinearScale, BarElement, Tooltip } from 'chart.js';
  Chart.register(BarController, CategoryScale, LinearScale, BarElement, Tooltip);

  // --- Weekly Time Chart ---
  const canvas = document.getElementById('weeklyTimeChart') as HTMLCanvasElement | null;
  if (canvas) {
    const labels = JSON.parse(canvas.getAttribute('data-labels') || '[]');
    const minutes: number[] = JSON.parse(canvas.getAttribute('data-minutes') || '[]');
    const hours = minutes.map((m) => +(m / 60).toFixed(2));

    new Chart(canvas, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          {
            label: 'Hours',
            data: hours,
            backgroundColor: 'rgba(99, 102, 241, 0.85)',
            hoverBackgroundColor: '#6366f1',
            borderRadius: 6,
            borderSkipped: false,
            barPercentage: 0.6,
            categoryPercentage: 0.7,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          tooltip: {
            backgroundColor: '#1e293b',
            titleColor: '#e2e8f0',
            bodyColor: '#94a3b8',
            borderColor: '#334155',
            borderWidth: 1,
            cornerRadius: 8,
            padding: { x: 14, y: 10 },
            callbacks: {
              label: function (ctx) {
                const mins = minutes[ctx.dataIndex];
                const h = Math.floor(mins / 60);
                const m = mins % 60;
                return ` ${h}h ${m}m`;
              },
            },
          },
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: { color: '#64748b', font: { size: 12, weight: '500' as const } },
            border: { display: false },
          },
          y: {
            grid: { color: 'rgba(51, 65, 85, 0.4)', drawTicks: false },
            ticks: {
              color: '#64748b',
              font: { size: 12 },
              padding: 8,
              callback: function (value) {
                return value + 'h';
              },
            },
            border: { display: false },
          },
        },
      },
    });
  }

  // --- Manual Entry Form Toggle ---
  const manualEntryBtn = document.getElementById('manual-entry-btn');
  const manualEntryForm = document.getElementById('manual-entry-form');
  const cancelEntryBtn = document.getElementById('cancel-entry-btn');

  manualEntryBtn?.addEventListener('click', () => {
    manualEntryForm?.classList.toggle('hidden');
  });

  cancelEntryBtn?.addEventListener('click', () => {
    manualEntryForm?.classList.add('hidden');
  });

  // --- localStorage-based time tracking ---
  const STORAGE_KEY = 'fd-time-entries';
  const TIMER_KEY = 'fd-active-timer';

  interface TimeEntry {
    id: string;
    taskId: string;
    projectId: string | null;
    description: string;
    startTime: string;
    endTime: string;
    durationMinutes: number;
    manual: boolean;
  }

  interface ActiveTimer {
    taskId: string;
    projectId: string | null;
    startTime: string;
  }

  function getStoredEntries(): TimeEntry[] {
    try {
      return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    } catch {
      return [];
    }
  }

  function saveEntries(entries: TimeEntry[]) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
  }

  function getActiveTimer(): ActiveTimer | null {
    try {
      const data = localStorage.getItem(TIMER_KEY);
      return data ? JSON.parse(data) : null;
    } catch {
      return null;
    }
  }

  function setActiveTimer(timer: ActiveTimer | null) {
    if (timer) {
      localStorage.setItem(TIMER_KEY, JSON.stringify(timer));
    } else {
      localStorage.removeItem(TIMER_KEY);
    }
  }

  // Task-to-project mapping (baked in from seed data)
  const taskProjectMap: Record<string, string | null> = {
    'task-001': 'proj-001',
    'task-002': 'proj-001',
    'task-003': 'proj-001',
    'task-004': 'proj-002',
    'task-005': 'proj-002',
    'task-006': 'proj-003',
    'task-007': 'proj-003',
    'task-008': 'proj-003',
    'task-009': 'proj-004',
    'task-010': null,
  };

  // --- Update active timer display ---
  const timerDisplay = document.getElementById('active-timer-display');
  const timerBadge = document.getElementById('timer-status-badge');

  function updateTimerDisplay() {
    const timer = getActiveTimer();
    if (!timer) {
      if (timerDisplay) timerDisplay.textContent = '0h 0m';
      if (timerBadge) {
        timerBadge.textContent = 'No active timer';
        timerBadge.className = 'inline-flex items-center gap-1 rounded-full bg-surface-700/50 px-2 py-0.5 text-[11px] font-medium text-surface-400';
      }
      return;
    }

    const elapsed = Date.now() - new Date(timer.startTime).getTime();
    const totalMin = Math.floor(elapsed / 60000);
    const h = Math.floor(totalMin / 60);
    const m = totalMin % 60;
    if (timerDisplay) timerDisplay.textContent = `${h}h ${m}m`;
    if (timerBadge) {
      timerBadge.innerHTML = '<span class="h-1.5 w-1.5 rounded-full bg-green-400 pulse-dot"></span> Running';
      timerBadge.className = 'inline-flex items-center gap-1 rounded-full bg-green-500/10 px-2 py-0.5 text-[11px] font-medium text-green-400';
    }
  }

  updateTimerDisplay();
  setInterval(updateTimerDisplay, 1000);

  // --- Manual Time Entry Submission ---
  document.getElementById('time-entry-form')?.addEventListener('submit', (e) => {
    e.preventDefault();
    const taskId = (document.getElementById('te-task-input') as HTMLSelectElement).value;
    const hours = parseInt((document.getElementById('te-hours-input') as HTMLInputElement).value) || 0;
    const minutes = parseInt((document.getElementById('te-minutes-input') as HTMLInputElement).value) || 0;
    const totalMinutes = hours * 60 + minutes;

    if (totalMinutes <= 0) return;

    const now = new Date();
    const entry: TimeEntry = {
      id: 'te-manual-' + Date.now(),
      taskId,
      projectId: taskProjectMap[taskId] || null,
      description: 'Manual time entry',
      startTime: now.toISOString(),
      endTime: now.toISOString(),
      durationMinutes: totalMinutes,
      manual: true,
    };

    const entries = getStoredEntries();
    entries.push(entry);
    saveEntries(entries);

    manualEntryForm?.classList.add('hidden');

    // Show confirmation
    const h = Math.floor(totalMinutes / 60);
    const m = totalMinutes % 60;
    const durationStr = h > 0 ? `${h}h ${m}m` : `${m}m`;
    showToast(`Logged ${durationStr} successfully`);
  });

  function showToast(message: string) {
    const toast = document.createElement('div');
    toast.className = 'fixed bottom-6 right-6 z-50 rounded-lg border border-green-500/30 bg-green-500/15 px-4 py-3 text-sm font-medium text-green-400 shadow-lg backdrop-blur-sm transition-all duration-300';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(10px)';
      setTimeout(() => toast.remove(), 300);
    }, 2500);
  }
</script>
