---
import DashboardLayout from '../../layouts/DashboardLayout.astro';
---

<DashboardLayout title="Tasks" active="tasks">
  <!-- Header -->
  <div class="mb-6 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
    <div>
      <h1 class="text-2xl font-bold text-surface-100 tracking-tight">Tasks</h1>
      <p id="task-summary" class="mt-1 text-sm text-surface-400"></p>
    </div>
    <div class="flex items-center gap-2">
      <button
        id="add-task-btn"
        class="inline-flex items-center gap-2 rounded-lg bg-accent-600 px-4 py-2.5 text-sm font-medium text-white transition-all hover:bg-accent-700 fd-glow-accent"
      >
        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
        </svg>
        Add Task
      </button>
    </div>
  </div>

  <!-- Add Task Form (hidden by default) -->
  <div id="add-task-form" class="mb-6 hidden fd-card bg-surface-900 p-5">
    <h3 class="mb-4 text-sm font-semibold text-surface-200">New Task</h3>
    <form id="new-task-form" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
      <div class="sm:col-span-2 lg:col-span-4">
        <input
          type="text"
          id="task-title-input"
          placeholder="Task title..."
          required
          class="w-full rounded-lg border border-surface-700 bg-surface-800/50 px-3 py-2 text-sm text-surface-200 placeholder:text-surface-500 focus:border-accent-500 focus:outline-none focus:ring-1 focus:ring-accent-500"
        />
      </div>
      <div>
        <select
          id="task-project-input"
          class="w-full rounded-lg border border-surface-700 bg-surface-800/50 px-3 py-2 text-sm text-surface-200 focus:border-accent-500 focus:outline-none focus:ring-1 focus:ring-accent-500"
        >
          <option value="">No project</option>
        </select>
      </div>
      <div>
        <select
          id="task-priority-input"
          class="w-full rounded-lg border border-surface-700 bg-surface-800/50 px-3 py-2 text-sm text-surface-200 focus:border-accent-500 focus:outline-none focus:ring-1 focus:ring-accent-500"
        >
          <option value="medium">Medium Priority</option>
          <option value="high">High Priority</option>
          <option value="low">Low Priority</option>
        </select>
      </div>
      <div>
        <input
          type="date"
          id="task-date-input"
          class="w-full rounded-lg border border-surface-700 bg-surface-800/50 px-3 py-2 text-sm text-surface-200 focus:border-accent-500 focus:outline-none focus:ring-1 focus:ring-accent-500"
        />
      </div>
      <div class="sm:col-span-2 lg:col-span-4">
        <textarea
          id="task-description-input"
          placeholder="Description (human-readable summary)..."
          rows="2"
          class="w-full rounded-lg border border-surface-700 bg-surface-800/50 px-3 py-2 text-sm text-surface-200 placeholder:text-surface-500 focus:border-accent-500 focus:outline-none focus:ring-1 focus:ring-accent-500"
        ></textarea>
      </div>
      <div class="sm:col-span-2 lg:col-span-4">
        <textarea
          id="task-prompt-input"
          placeholder="Agent prompt (instructions for Claude Code agents)..."
          rows="3"
          class="w-full rounded-lg border border-surface-700 bg-surface-800/50 px-3 py-2 text-sm text-surface-200 placeholder:text-surface-500 focus:border-accent-500 focus:outline-none focus:ring-1 focus:ring-accent-500"
        ></textarea>
      </div>
      <div class="flex items-end gap-2">
        <button
          type="submit"
          class="rounded-lg bg-accent-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-accent-700"
        >
          Add
        </button>
        <button
          type="button"
          id="cancel-task-btn"
          class="rounded-lg border border-surface-700 px-4 py-2 text-sm font-medium text-surface-400 transition-colors hover:bg-surface-800 hover:text-surface-200"
        >
          Cancel
        </button>
      </div>
    </form>
  </div>

  <!-- Filter Bar -->
  <div id="filter-bar" class="mb-4 flex flex-wrap items-center gap-3 rounded-xl border border-surface-700/30 bg-surface-900/80 p-3 sm:p-4">
    <!-- Project -->
    <div class="flex items-center gap-2">
      <label for="filter-project" class="text-[10px] font-semibold uppercase tracking-widest text-surface-500">Project</label>
      <select id="filter-project" class="fd-filter-select">
        <option value="all">All</option>
      </select>
    </div>

    <div class="hidden h-6 w-px bg-surface-700/50 sm:block"></div>

    <!-- Priority -->
    <div class="flex items-center gap-2">
      <label for="filter-priority" class="text-[10px] font-semibold uppercase tracking-widest text-surface-500">Priority</label>
      <select id="filter-priority" class="fd-filter-select">
        <option value="all">All</option>
        <option value="high">High</option>
        <option value="medium">Medium</option>
        <option value="low">Low</option>
      </select>
    </div>

    <div class="hidden h-6 w-px bg-surface-700/50 sm:block"></div>

    <!-- Status -->
    <div class="flex items-center gap-2">
      <label for="filter-status" class="text-[10px] font-semibold uppercase tracking-widest text-surface-500">Status</label>
      <select id="filter-status" class="fd-filter-select">
        <option value="all">All</option>
        <option value="todo">To Do</option>
        <option value="in-progress">In Progress</option>
        <option value="done">Done</option>
      </select>
    </div>

    <div class="hidden h-6 w-px bg-surface-700/50 sm:block"></div>

    <!-- Assignee -->
    <div class="flex items-center gap-2">
      <label for="filter-assignee" class="text-[10px] font-semibold uppercase tracking-widest text-surface-500">Assignee</label>
      <select id="filter-assignee" class="fd-filter-select">
        <option value="all">All</option>
        <option value="mine">My Tasks</option>
      </select>
    </div>
  </div>

  <!-- Task List -->
  <div id="task-list" class="space-y-2"></div>

  <!-- Empty state -->
  <div id="empty-state" class="hidden py-12 text-center">
    <svg class="mx-auto h-12 w-12 text-surface-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
    </svg>
    <p id="empty-state-text" class="mt-3 text-sm text-surface-400">No tasks yet. Add your first task to get started.</p>
  </div>

  <!-- Task Detail Panel (slide-out drawer) -->
  <div id="detail-overlay" class="fixed inset-0 z-40 hidden bg-black/60 backdrop-blur-sm transition-opacity"></div>
  <div id="detail-panel" class="fixed right-0 top-0 z-50 hidden h-full w-full max-w-lg translate-x-full overflow-y-auto border-l border-surface-700/50 bg-surface-900 shadow-2xl shadow-black/40 transition-transform duration-200 ease-out sm:w-[32rem]">
    <div class="flex items-center justify-between border-b border-surface-700/50 px-6 py-4">
      <h2 class="text-lg font-bold text-surface-100">Task Details</h2>
      <button id="detail-close-btn" class="rounded-lg p-1.5 text-surface-400 transition-colors hover:bg-surface-800 hover:text-surface-200">
        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>
      </button>
    </div>
    <div id="detail-content" class="px-6 py-5"></div>
  </div>
</DashboardLayout>

<style>
  /* Filter styles now handled by fd-filter-chip in global.css */
</style>

<script>
  import { initStore, getTasks, getTask, getProjects, addTask, updateTask, deleteTask, getCurrentUser, isAssignedToCurrentUser } from '../../lib/store';
  import type { Task } from '../../lib/store';

  // Initialize store from API before any reads
  await initStore();

  const priorityColors: Record<string, string> = {
    high: 'bg-red-500',
    medium: 'bg-amber-500',
    low: 'bg-blue-500',
  };

  const statusLabels: Record<string, string> = {
    'todo': 'To Do',
    'in-progress': 'In Progress',
    'done': 'Done',
  };

  const statusColors: Record<string, string> = {
    'todo': 'text-surface-500',
    'in-progress': 'text-blue-400',
    'done': 'text-green-400',
  };

  let activeProject = 'all';
  let activePriority = 'all';
  let activeStatus = 'all';
  let activeAssignee = 'all';
  let showAllDone = false;

  function getDueDateClass(dateStr: string | null): string {
    if (!dateStr) return 'text-surface-400';
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const threeDays = new Date(today);
    threeDays.setDate(threeDays.getDate() + 3);
    const due = new Date(dateStr);
    due.setHours(0, 0, 0, 0);
    if (due < today) return 'text-red-400';
    if (due <= threeDays) return 'text-amber-400';
    return 'text-surface-400';
  }

  function formatDate(dateStr: string | null): string {
    if (!dateStr) return 'No date';
    const d = new Date(dateStr);
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  }

  function escapeHtml(str: string): string {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function renderProjectFilters() {
    const projects = getProjects();
    const tasks = getTasks();
    const taskProjectRefs = new Set(tasks.filter(t => t.project).map(t => t.project));
    const select = document.getElementById('filter-project') as HTMLSelectElement;
    if (!select) return;

    // Preserve current selection
    const current = select.value;
    select.innerHTML = '<option value="all">All</option>';
    projects.forEach(p => {
      if (taskProjectRefs.has(p.id) || taskProjectRefs.has(p.title)) {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.title;
        select.appendChild(opt);
      }
    });
    // Restore selection if still valid, else reset
    if ([...select.options].some(o => o.value === current)) {
      select.value = current;
    } else {
      select.value = 'all';
      activeProject = 'all';
    }
  }

  function renderProjectSelect() {
    const projects = getProjects();
    const select = document.getElementById('task-project-input') as HTMLSelectElement;
    if (!select) return;
    select.innerHTML = '<option value="">No project</option>';
    projects.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = p.title;
      select.appendChild(opt);
    });
  }

  function renderTasks() {
    const tasks = getTasks();
    const projects = getProjects();
    const projectMap = Object.fromEntries([
      ...projects.map(p => [p.id, p]),
      ...projects.map(p => [p.title, p]),
    ]);

    const sorted = [...tasks].sort((a, b) => {
      if (a.status === 'done' && b.status !== 'done') return 1;
      if (a.status !== 'done' && b.status === 'done') return -1;
      const dateA = a.dueDate ? new Date(a.dueDate).getTime() : Infinity;
      const dateB = b.dueDate ? new Date(b.dueDate).getTime() : Infinity;
      return dateA - dateB;
    });

    // Limit done tasks to 5 most recent unless showAllDone is true
    const nonDone = sorted.filter(t => t.status !== 'done');
    const doneTasks = sorted.filter(t => t.status === 'done')
      .sort((a, b) => (b.completedAt || '').localeCompare(a.completedAt || ''));
    const visibleDone = showAllDone ? doneTasks : doneTasks.slice(0, 5);
    const hiddenDoneCount = doneTasks.length - visibleDone.length;
    const tasksToRender = [...nonDone, ...visibleDone];

    const activeTasks = tasks.filter(t => t.status !== 'done').length;
    const summary = document.getElementById('task-summary');
    if (summary) summary.textContent = `${activeTasks} active tasks, ${tasks.length} total`;

    const taskList = document.getElementById('task-list');
    const emptyState = document.getElementById('empty-state');
    const emptyText = document.getElementById('empty-state-text');

    if (!taskList) return;

    if (tasksToRender.length === 0 && hiddenDoneCount === 0) {
      taskList.innerHTML = '';
      if (emptyState) emptyState.classList.remove('hidden');
      if (emptyText) emptyText.textContent = 'No tasks yet. Add your first task to get started.';
      return;
    }

    if (emptyState) emptyState.classList.add('hidden');

    taskList.innerHTML = tasksToRender.map(task => {
      const proj = task.project ? projectMap[task.project] : null;
      const isDone = task.status === 'done';
      const checkboxClasses = isDone
        ? 'border-green-500 bg-green-500'
        : 'border-surface-600 hover:border-accent-400';
      const checkSvg = isDone
        ? '<svg class="h-3 w-3 text-white" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>'
        : '';
      const titleClasses = isDone ? 'text-surface-500 line-through' : 'text-surface-200';
      const opacityClass = isDone ? 'opacity-50' : '';

      const projectHtml = proj
        ? `<span class="hidden items-center gap-1.5 text-xs text-surface-400 sm:flex">
            <span class="h-2 w-2 rounded-full" style="background-color: ${proj.color}"></span>
            ${escapeHtml(proj.title)}
          </span>`
        : '';

      // Prompt indicator — small icon if task has agent instructions
      const promptHtml = task.prompt
        ? `<span class="flex-shrink-0 text-accent-400" title="Has agent prompt">
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="m6.75 7.5 3 2.25-3 2.25m4.5 0h3m-9 8.25h13.5A2.25 2.25 0 0 0 21 18V6a2.25 2.25 0 0 0-2.25-2.25H5.25A2.25 2.25 0 0 0 3 6v12a2.25 2.25 0 0 0 2.25 2.25Z" />
            </svg>
          </span>`
        : '';

      // Assignee badge or Claim button
      const currentUser = getCurrentUser();
      const assigneeHtml = task.assignee
        ? `<span class="hidden flex-shrink-0 items-center rounded-full bg-accent-600/15 px-2 py-0.5 text-[10px] font-semibold text-accent-400 sm:flex">${escapeHtml(task.assignee)}</span>`
        : `<button class="task-claim-btn hidden flex-shrink-0 items-center text-xs text-accent-400 hover:bg-accent-600/15 px-2 py-0.5 rounded-full transition-colors sm:flex" data-id="${task.id}">Claim</button>`;

      // Done permission guard: disable checkbox if assigned to someone else
      const canToggleDone = !task.assignee || isAssignedToCurrentUser(task);
      const checkboxDisabledAttr = canToggleDone ? '' : ' title="Only the assignee can mark this done"';
      const checkboxDisabledClass = canToggleDone ? '' : ' opacity-30 cursor-not-allowed';

      const priorityDotClass = task.priority === 'high' ? `${priorityColors[task.priority] || 'bg-surface-500'} fd-priority-high` : (priorityColors[task.priority] || 'bg-surface-500');

      return `<div
        class="task-item fd-task-row group ${opacityClass}"
        data-project="${proj ? proj.id : (task.project || 'none')}"
        data-priority="${task.priority}"
        data-status="${task.status}"
        data-assignee="${escapeHtml(task.assignee)}"
        data-id="${task.id}"
      >
        <div class="flex items-center gap-3 px-4 py-3.5">
          <button class="task-checkbox flex h-5 w-5 flex-shrink-0 items-center justify-center rounded-full border-2 transition-all ${checkboxClasses}${checkboxDisabledClass}"${checkboxDisabledAttr} aria-label="Toggle task">${checkSvg}</button>
          <span class="h-2 w-2 flex-shrink-0 rounded-full ${priorityDotClass}" title="${task.priority}"></span>
          <span class="task-title-btn flex-1 cursor-pointer text-left text-sm font-medium transition-colors hover:text-accent-400 ${titleClasses}" role="button" tabindex="0" data-id="${task.id}">${escapeHtml(task.title)}</span>
          ${promptHtml}
          ${assigneeHtml}
          ${projectHtml}
          <span class="hidden text-xs sm:block ${getDueDateClass(task.dueDate)}">${formatDate(task.dueDate)}</span>
          <span class="hidden rounded-full px-2 py-0.5 text-[10px] font-semibold md:inline-block ${statusColors[task.status] || 'text-surface-400'}">${statusLabels[task.status] || task.status}</span>
          <button class="task-delete-btn ml-1 hidden h-5 w-5 flex-shrink-0 items-center justify-center rounded text-surface-600 transition-colors hover:bg-red-500/10 hover:text-red-400 group-hover:flex" aria-label="Delete task" title="Delete task">
            <svg class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>
          </button>
        </div>
      </div>`;
    }).join('');

    // Append "Show all done tasks" link if there are hidden done tasks
    if (hiddenDoneCount > 0) {
      taskList.innerHTML += `<div id="show-all-done" class="flex items-center justify-center border-t border-surface-700/30 py-3 text-sm">
        <button class="text-accent-400 hover:text-accent-300 transition-colors">
          Show all ${doneTasks.length} done tasks
        </button>
      </div>`;
    }

    // Attach "Show all done" button listener
    const showAllDoneBtn = document.getElementById('show-all-done');
    if (showAllDoneBtn) {
      showAllDoneBtn.addEventListener('click', () => {
        // Activate the Done status filter
        activeStatus = 'done';
        showAllDone = true;
        // Update filter dropdown UI
        const statusSelect = document.getElementById('filter-status') as HTMLSelectElement;
        if (statusSelect) statusSelect.value = 'done';
        renderTasks();
      });
    }

    // Attach checkbox listeners (with permission guard)
    taskList.querySelectorAll('.task-checkbox').forEach(btn => {
      btn.addEventListener('click', () => {
        const taskItem = btn.closest('.task-item') as HTMLElement;
        if (!taskItem) return;
        const id = taskItem.dataset.id!;
        const task = getTask(id);
        if (!task) return;
        // Guard: only assignee or unassigned can toggle done
        if (task.assignee && !isAssignedToCurrentUser(task)) return;
        const isDone = taskItem.dataset.status === 'done';
        updateTask(id, { status: isDone ? 'todo' : 'done' });
        renderTasks();
        renderProjectFilters();
        applyFilters();
      });
    });

    // Attach claim button listeners
    taskList.querySelectorAll('.task-claim-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = (btn as HTMLElement).dataset.id!;
        const user = getCurrentUser();
        updateTask(id, { assignee: user.assigneeId });
        renderTasks();
        renderProjectFilters();
        applyFilters();
      });
    });

    // Attach delete listeners
    taskList.querySelectorAll('.task-delete-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const taskItem = btn.closest('.task-item') as HTMLElement;
        if (!taskItem) return;
        const id = taskItem.dataset.id!;
        if (!confirm('Delete this task?')) return;
        deleteTask(id);
        renderTasks();
        renderProjectFilters();
        applyFilters();
      });
    });

    // Attach title click → open detail panel
    taskList.querySelectorAll('.task-title-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = (btn as HTMLElement).dataset.id!;
        openDetailPanel(id);
      });
    });

    applyFilters();
  }

  function applyFilters() {
    const items = document.querySelectorAll('.task-item');
    const currentUser = getCurrentUser();
    let visibleCount = 0;
    items.forEach(el => {
      const item = el as HTMLElement;
      const matchProject = activeProject === 'all' || item.dataset.project === activeProject;
      const matchPriority = activePriority === 'all' || item.dataset.priority === activePriority;
      const matchStatus = activeStatus === 'all' || item.dataset.status === activeStatus;
      let matchAssignee = true;
      if (activeAssignee === 'mine') {
        const assignee = (item.dataset.assignee || '').toLowerCase().trim();
        matchAssignee = assignee === currentUser.assigneeId || assignee === currentUser.name.toLowerCase();
      }
      const visible = matchProject && matchPriority && matchStatus && matchAssignee;
      item.style.display = visible ? '' : 'none';
      if (visible) visibleCount++;
    });
    const emptyState = document.getElementById('empty-state');
    const emptyText = document.getElementById('empty-state-text');
    const tasks = getTasks();
    if (tasks.length === 0) {
      if (emptyState) emptyState.classList.remove('hidden');
      if (emptyText) emptyText.textContent = 'No tasks yet. Add your first task to get started.';
    } else if (visibleCount === 0) {
      if (emptyState) emptyState.classList.remove('hidden');
      if (emptyText) emptyText.textContent = 'No tasks match the current filters.';
    } else {
      if (emptyState) emptyState.classList.add('hidden');
    }
  }

  // Project filter
  document.getElementById('filter-project')?.addEventListener('change', (e) => {
    activeProject = (e.target as HTMLSelectElement).value;
    applyFilters();
  });

  // Priority filter
  document.getElementById('filter-priority')?.addEventListener('change', (e) => {
    activePriority = (e.target as HTMLSelectElement).value;
    applyFilters();
  });

  // Status filter
  document.getElementById('filter-status')?.addEventListener('change', (e) => {
    activeStatus = (e.target as HTMLSelectElement).value;
    showAllDone = (activeStatus === 'done');
    renderTasks();
  });

  // Assignee filter
  document.getElementById('filter-assignee')?.addEventListener('change', (e) => {
    activeAssignee = (e.target as HTMLSelectElement).value;
    applyFilters();
  });

  // Add task form toggle
  const addBtn = document.getElementById('add-task-btn');
  const addForm = document.getElementById('add-task-form');
  const cancelBtn = document.getElementById('cancel-task-btn');

  addBtn?.addEventListener('click', () => addForm?.classList.toggle('hidden'));
  cancelBtn?.addEventListener('click', () => addForm?.classList.add('hidden'));

  // Add task submission
  document.getElementById('new-task-form')?.addEventListener('submit', (e) => {
    e.preventDefault();
    const title = (document.getElementById('task-title-input') as HTMLInputElement).value.trim();
    const project = (document.getElementById('task-project-input') as HTMLSelectElement).value;
    const priority = (document.getElementById('task-priority-input') as HTMLSelectElement).value as 'high' | 'medium' | 'low';
    const dueDate = (document.getElementById('task-date-input') as HTMLInputElement).value;
    const prompt = (document.getElementById('task-prompt-input') as HTMLTextAreaElement).value.trim();

    if (!title) return;

    addTask({
      title,
      project: project || null,
      priority,
      status: 'todo',
      dueDate: dueDate || '',
      description: (document.getElementById('task-description-input') as HTMLTextAreaElement).value.trim(),
      prompt,
    });

    // Reset form
    (document.getElementById('task-title-input') as HTMLInputElement).value = '';
    (document.getElementById('task-project-input') as HTMLSelectElement).value = '';
    (document.getElementById('task-priority-input') as HTMLSelectElement).value = 'medium';
    (document.getElementById('task-date-input') as HTMLInputElement).value = '';
    (document.getElementById('task-prompt-input') as HTMLTextAreaElement).value = '';
    (document.getElementById('task-description-input') as HTMLTextAreaElement).value = '';
    addForm?.classList.add('hidden');

    renderTasks();
    renderProjectFilters();
    renderProjectSelect();
  });

  // ── Detail panel ──────────────────────────────────────────────────────────

  const detailPanel = document.getElementById('detail-panel')!;
  const detailOverlay = document.getElementById('detail-overlay')!;
  const detailContent = document.getElementById('detail-content')!;

  const priorityBadgeClasses: Record<string, string> = {
    high: 'bg-red-500/15 text-red-400',
    medium: 'bg-amber-500/15 text-amber-400',
    low: 'bg-blue-500/15 text-blue-400',
  };

  const statusBadgeClasses: Record<string, string> = {
    'todo': 'bg-surface-500/15 text-surface-400',
    'in-progress': 'bg-blue-500/15 text-blue-400',
    'done': 'bg-green-500/15 text-green-400',
  };

  const inputClasses = 'w-full rounded-lg border border-surface-700 bg-surface-800/50 px-3 py-2 text-sm text-surface-200 placeholder:text-surface-500 focus:border-accent-500 focus:outline-none focus:ring-1 focus:ring-accent-500';

  function showPanel() {
    detailOverlay.classList.remove('hidden');
    detailPanel.classList.remove('hidden');
    requestAnimationFrame(() => {
      detailPanel.classList.remove('translate-x-full');
    });
  }

  function openDetailPanel(taskId: string) {
    const task = getTask(taskId);
    if (!task) return;

    const projects = getProjects();
    const proj = task.project ? projects.find(p => p.id === task.project) : null;

    const fields: Array<{ label: string; value: string; html?: string }> = [
      { label: 'ID', value: '', html: `<code class="rounded bg-surface-800 px-1.5 py-0.5 text-xs text-surface-300">${escapeHtml(task.id)}</code>` },
      { label: 'Status', value: '', html: `<span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold ${statusBadgeClasses[task.status] || ''}">${statusLabels[task.status] || task.status}</span>` },
      { label: 'Priority', value: '', html: `<span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold uppercase ${priorityBadgeClasses[task.priority] || ''}">${task.priority}</span>` },
      { label: 'Project', value: proj ? proj.title : 'None', html: proj ? `<span class="inline-flex items-center gap-1.5 text-sm text-surface-200"><span class="h-2 w-2 rounded-full" style="background-color: ${proj.color}"></span>${escapeHtml(proj.title)}</span>` : undefined },
      { label: 'Due Date', value: task.dueDate ? new Date(task.dueDate).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) : 'No date' },
      { label: 'Assignee', value: task.assignee || 'Unassigned' },
    ];
    if (task.completedAt) {
      fields.push({ label: 'Completed', value: new Date(task.completedAt).toLocaleString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' }) });
    }

    detailContent.innerHTML = `
      <div class="mb-6 flex items-start justify-between gap-4">
        <h3 class="text-xl font-semibold text-surface-100">${escapeHtml(task.title)}</h3>
        <button id="detail-edit-btn" class="flex-shrink-0 inline-flex items-center gap-1.5 rounded-lg border border-surface-700 px-3 py-1.5 text-xs font-medium text-surface-400 transition-colors hover:border-surface-600 hover:text-surface-200" data-id="${task.id}">
          <svg class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
          </svg>
          Edit
        </button>
      </div>

      <div class="mb-6 space-y-3">
        ${fields.map(f => `
          <div class="flex items-start justify-between gap-4">
            <span class="flex-shrink-0 text-xs font-medium uppercase tracking-wider text-surface-500">${f.label}</span>
            <span class="text-right text-sm text-surface-300">${f.html || escapeHtml(f.value)}</span>
          </div>
        `).join('')}
      </div>

      <div class="mb-6">
        <h4 class="mb-2 text-xs font-medium uppercase tracking-wider text-surface-500">Description</h4>
        ${task.description
          ? `<p class="text-sm leading-relaxed text-surface-300">${escapeHtml(task.description)}</p>`
          : `<p class="text-sm italic text-surface-500">No description.</p>`
        }
      </div>

      <div class="mb-2">
        <h4 class="mb-2 text-xs font-medium uppercase tracking-wider text-surface-500">Agent Prompt</h4>
        ${task.prompt
          ? `<button id="prompt-toggle" class="flex items-center gap-2 text-sm font-medium text-accent-400 hover:text-accent-300 transition-colors">
              <svg id="prompt-chevron" class="h-4 w-4 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
              See Prompt
            </button>
            <div id="prompt-content" class="mt-3 hidden">
              <div class="relative rounded-lg border border-surface-700/50 bg-surface-800/50 p-4">
                <button id="copy-prompt-btn" class="absolute right-2 top-2 rounded px-2 py-1 text-xs font-medium text-surface-400 hover:bg-surface-700 hover:text-surface-200 transition-colors" title="Copy prompt">Copy</button>
                <pre class="whitespace-pre-wrap pr-16 text-sm leading-relaxed text-surface-300">${escapeHtml(task.prompt)}</pre>
              </div>
            </div>`
          : `<p class="text-sm italic text-surface-500">No prompt — this is a human-only task.</p>`
        }
      </div>
    `;

    document.getElementById('detail-edit-btn')!.addEventListener('click', () => {
      openEditPanel(task.id);
    });

    const promptToggle = document.getElementById('prompt-toggle');
    const promptContent = document.getElementById('prompt-content');
    const promptChevron = document.getElementById('prompt-chevron');
    const copyBtn = document.getElementById('copy-prompt-btn');

    if (promptToggle && promptContent && promptChevron) {
      promptToggle.addEventListener('click', () => {
        promptContent.classList.toggle('hidden');
        promptChevron.classList.toggle('rotate-90');
        promptToggle.innerHTML = promptContent.classList.contains('hidden')
          ? '<svg class="h-4 w-4 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg> See Prompt'
          : '<svg class="h-4 w-4 rotate-90 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg> Hide Prompt';
      });
    }

    if (copyBtn) {
      copyBtn.addEventListener('click', () => {
        navigator.clipboard.writeText(task.prompt).then(() => {
          copyBtn.textContent = 'Copied!';
          setTimeout(() => { copyBtn.textContent = 'Copy'; }, 1500);
        });
      });
    }

    showPanel();
  }

  function openEditPanel(taskId: string) {
    const task = getTask(taskId);
    if (!task) return;

    const projects = getProjects();
    const projectOptions = projects.map(p =>
      `<option value="${p.id}" ${task.project === p.id ? 'selected' : ''}>${escapeHtml(p.title)}</option>`
    ).join('');

    detailContent.innerHTML = `
      <form id="edit-task-form" class="space-y-4">
        <div>
          <label class="mb-1 block text-xs font-medium uppercase tracking-wider text-surface-500">Title</label>
          <input type="text" id="ef-title" value="${escapeHtml(task.title)}" required class="${inputClasses}" />
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="mb-1 block text-xs font-medium uppercase tracking-wider text-surface-500">Status</label>
            <select id="ef-status" class="${inputClasses}">
              <option value="todo" ${task.status === 'todo' ? 'selected' : ''}>To Do</option>
              <option value="in-progress" ${task.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
              <option value="done" ${task.status === 'done' ? 'selected' : ''}>Done</option>
            </select>
          </div>
          <div>
            <label class="mb-1 block text-xs font-medium uppercase tracking-wider text-surface-500">Priority</label>
            <select id="ef-priority" class="${inputClasses}">
              <option value="high" ${task.priority === 'high' ? 'selected' : ''}>High</option>
              <option value="medium" ${task.priority === 'medium' ? 'selected' : ''}>Medium</option>
              <option value="low" ${task.priority === 'low' ? 'selected' : ''}>Low</option>
            </select>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="mb-1 block text-xs font-medium uppercase tracking-wider text-surface-500">Project</label>
            <select id="ef-project" class="${inputClasses}">
              <option value="">No project</option>
              ${projectOptions}
            </select>
          </div>
          <div>
            <label class="mb-1 block text-xs font-medium uppercase tracking-wider text-surface-500">Due Date</label>
            <input type="date" id="ef-due" value="${task.dueDate || ''}" class="${inputClasses}" />
          </div>
        </div>
        <div>
          <label class="mb-1 block text-xs font-medium uppercase tracking-wider text-surface-500">Assignee</label>
          <input type="text" id="ef-assignee" value="${escapeHtml(task.assignee)}" placeholder="e.g. human, agent-1" class="${inputClasses}" />
        </div>
        <div>
          <label class="mb-1 block text-xs font-medium uppercase tracking-wider text-surface-500">Description</label>
          <textarea id="ef-description" rows="2" placeholder="Description..." class="${inputClasses}">${escapeHtml(task.description)}</textarea>
        </div>
        <div>
          <label class="mb-1 block text-xs font-medium uppercase tracking-wider text-surface-500">Agent Prompt</label>
          <textarea id="ef-prompt" rows="6" placeholder="Instructions for Claude Code agents..." class="${inputClasses}">${escapeHtml(task.prompt)}</textarea>
        </div>
        <div class="flex items-center gap-2 pt-2">
          <button type="submit" class="rounded-lg bg-accent-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-accent-700">Save</button>
          <button type="button" id="edit-cancel-btn" class="rounded-lg border border-surface-700 px-4 py-2 text-sm font-medium text-surface-400 transition-colors hover:bg-surface-800 hover:text-surface-200">Cancel</button>
        </div>
        <p class="text-xs text-surface-500">ID: <code class="rounded bg-surface-800 px-1 py-0.5 text-surface-400">${escapeHtml(task.id)}</code></p>
      </form>
    `;

    document.getElementById('edit-cancel-btn')!.addEventListener('click', () => {
      openDetailPanel(taskId);
    });

    document.getElementById('edit-task-form')!.addEventListener('submit', (e) => {
      e.preventDefault();
      const title = (document.getElementById('ef-title') as HTMLInputElement).value.trim();
      if (!title) return;

      updateTask(taskId, {
        title,
        status: (document.getElementById('ef-status') as HTMLSelectElement).value as Task['status'],
        priority: (document.getElementById('ef-priority') as HTMLSelectElement).value as Task['priority'],
        project: (document.getElementById('ef-project') as HTMLSelectElement).value || null,
        dueDate: (document.getElementById('ef-due') as HTMLInputElement).value || '',
        assignee: (document.getElementById('ef-assignee') as HTMLInputElement).value.trim(),
        description: (document.getElementById('ef-description') as HTMLTextAreaElement).value.trim(),
        prompt: (document.getElementById('ef-prompt') as HTMLTextAreaElement).value.trim(),
      });

      renderTasks();
      renderProjectFilters();
      openDetailPanel(taskId);
    });
  }

  function closeDetailPanel() {
    detailPanel.classList.add('translate-x-full');
    // Wait for transition to finish, then hide
    setTimeout(() => {
      detailPanel.classList.add('hidden');
      detailOverlay.classList.add('hidden');
    }, 200);
  }

  document.getElementById('detail-close-btn')!.addEventListener('click', closeDetailPanel);
  detailOverlay.addEventListener('click', closeDetailPanel);
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !detailPanel.classList.contains('hidden')) {
      closeDetailPanel();
    }
  });

  // Initial render
  renderProjectFilters();
  renderProjectSelect();
  renderTasks();
</script>
