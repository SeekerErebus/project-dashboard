---
import DashboardLayout from '../../layouts/DashboardLayout.astro';
---

<DashboardLayout title="Calendar" active="calendar">
  <!-- Calendar Header -->
  <div class="mb-6 flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-bold text-surface-100 tracking-tight" id="calendar-title">February 2026</h1>
      <p class="mt-1 text-sm text-surface-400">Task and project deadlines</p>
    </div>
    <div class="flex items-center gap-2">
      <button
        id="today-btn"
        class="rounded-lg border border-surface-700/60 bg-surface-800/40 px-3 py-2 text-sm font-medium text-surface-300 transition-all hover:bg-surface-800 hover:text-surface-200 hover:border-surface-600"
      >
        Today
      </button>
      <button
        id="prev-btn"
        class="rounded-lg border border-surface-700/60 bg-surface-800/40 p-2 text-surface-400 transition-all hover:bg-surface-800 hover:text-surface-200 hover:border-surface-600"
        aria-label="Previous month"
      >
        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
        </svg>
      </button>
      <button
        id="next-btn"
        class="rounded-lg border border-surface-700/60 bg-surface-800/40 p-2 text-surface-400 transition-all hover:bg-surface-800 hover:text-surface-200 hover:border-surface-600"
        aria-label="Next month"
      >
        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Calendar Grid -->
  <div class="fd-card overflow-hidden">
    <!-- Day headers -->
    <div class="grid grid-cols-7 border-b border-surface-700/50">
      <div class="py-3 text-center text-xs font-semibold uppercase tracking-wider text-surface-400">Mon</div>
      <div class="py-3 text-center text-xs font-semibold uppercase tracking-wider text-surface-400">Tue</div>
      <div class="py-3 text-center text-xs font-semibold uppercase tracking-wider text-surface-400">Wed</div>
      <div class="py-3 text-center text-xs font-semibold uppercase tracking-wider text-surface-400">Thu</div>
      <div class="py-3 text-center text-xs font-semibold uppercase tracking-wider text-surface-400">Fri</div>
      <div class="py-3 text-center text-xs font-semibold uppercase tracking-wider text-surface-400">Sat</div>
      <div class="py-3 text-center text-xs font-semibold uppercase tracking-wider text-surface-400">Sun</div>
    </div>
    <!-- Calendar days (rendered by JS) -->
    <div id="calendar-grid" class="grid grid-cols-7"></div>
  </div>

  <!-- Legend (rendered by JS) -->
  <div id="calendar-legend" class="mt-4 flex flex-wrap items-center gap-4 text-xs text-surface-400"></div>
</DashboardLayout>

<script>
  import { initStore, getTasks, getProjects } from '../../lib/store';

  // Initialize store from API before any reads
  await initStore();

  interface CalendarEvent {
    date: string;
    title: string;
    color: string;
    type: string;
  }

  const projects = getProjects();
  const tasks = getTasks();

  const projectMap = Object.fromEntries(projects.map((p) => [p.id, p]));

  const calendarEvents: CalendarEvent[] = [];

  // Task due dates
  tasks.forEach((task) => {
    if (task.dueDate) {
      const proj = task.project ? projectMap[task.project] : null;
      calendarEvents.push({
        date: task.dueDate,
        title: task.title,
        color: proj ? proj.color : '#6366f1',
        type: 'task',
      });
    }
  });

  // Project due dates
  projects.forEach((proj) => {
    if (proj.dueDate) {
      calendarEvents.push({
        date: proj.dueDate,
        title: `${proj.title} due`,
        color: proj.color,
        type: 'project',
      });
    }
  });

  // Render legend
  const legendEl = document.getElementById('calendar-legend');
  if (legendEl) {
    let legendHtml = `
      <span class="flex items-center gap-1.5">
        <span class="h-2 w-2 rounded-full bg-accent-500"></span>
        Today
      </span>
    `;
    projects.forEach((p) => {
      legendHtml += `
        <span class="flex items-center gap-1.5">
          <span class="h-2 w-2 rounded-full" style="background-color: ${p.color}"></span>
          ${p.title}
        </span>
      `;
    });
    if (projects.length === 0) {
      legendHtml += `
        <span class="flex items-center gap-1.5">
          <span class="h-2 w-2 rounded-full bg-accent-500"></span>
          Tasks
        </span>
      `;
    }
    legendEl.innerHTML = legendHtml;
  }

  const now = new Date();
  let currentYear = now.getFullYear();
  let currentMonth = now.getMonth(); // 0-indexed

  const monthNames = [
    'January', 'February', 'March', 'April', 'May', 'June',
    'July', 'August', 'September', 'October', 'November', 'December'
  ];

  function getEventsForDate(year: number, month: number, day: number) {
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    return calendarEvents.filter(e => e.date === dateStr);
  }

  function renderCalendar() {
    const titleEl = document.getElementById('calendar-title');
    if (titleEl) titleEl.textContent = `${monthNames[currentMonth]} ${currentYear}`;

    const grid = document.getElementById('calendar-grid');
    if (!grid) return;
    grid.innerHTML = '';

    const firstDay = new Date(currentYear, currentMonth, 1);
    const lastDay = new Date(currentYear, currentMonth + 1, 0);
    const daysInMonth = lastDay.getDate();

    // Monday=0, so adjust: JS getDay() has Sunday=0
    let startDow = firstDay.getDay() - 1;
    if (startDow < 0) startDow = 6;

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const todayDate = today.getDate();
    const todayMonth = today.getMonth();
    const todayYear = today.getFullYear();

    // Previous month days
    const prevMonthLastDay = new Date(currentYear, currentMonth, 0).getDate();
    for (let i = startDow - 1; i >= 0; i--) {
      const day = prevMonthLastDay - i;
      const cell = createDayCell(day, true, false, currentYear, currentMonth - 1, day);
      grid.appendChild(cell);
    }

    // Current month days
    for (let day = 1; day <= daysInMonth; day++) {
      const isToday = day === todayDate && currentMonth === todayMonth && currentYear === todayYear;
      const cell = createDayCell(day, false, isToday, currentYear, currentMonth, day);
      grid.appendChild(cell);
    }

    // Next month days to fill grid
    const totalCells = grid.children.length;
    const remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
    for (let day = 1; day <= remaining; day++) {
      const cell = createDayCell(day, true, false, currentYear, currentMonth + 1, day);
      grid.appendChild(cell);
    }
  }

  function createDayCell(day: number, dimmed: boolean, isToday: boolean, evtYear: number, evtMonth: number, evtDay: number) {
    const cell = document.createElement('div');
    cell.className = 'fd-cal-day min-h-[80px] sm:min-h-[100px] border-b border-r border-surface-700/30 p-1.5 sm:p-2';

    // Day number
    const dayNum = document.createElement('span');
    dayNum.className = 'inline-flex h-6 w-6 items-center justify-center rounded-full text-xs font-medium';
    if (isToday) {
      dayNum.className += ' bg-accent-600 text-white';
    } else if (dimmed) {
      dayNum.className += ' text-surface-600';
    } else {
      dayNum.className += ' text-surface-300';
    }
    dayNum.textContent = String(day);
    cell.appendChild(dayNum);

    // Events for this date
    if (!dimmed) {
      const dayEvents = getEventsForDate(evtYear, evtMonth, evtDay);
      if (dayEvents.length > 0) {
        const eventsContainer = document.createElement('div');
        eventsContainer.className = 'mt-1 space-y-0.5';

        dayEvents.forEach((evt, idx) => {
          if (idx < 3) {
            const eventEl = document.createElement('div');
            eventEl.className = 'flex items-center gap-1 rounded px-1 py-0.5 text-[10px] sm:text-xs leading-tight truncate';
            eventEl.style.backgroundColor = evt.color + '20';
            eventEl.style.color = evt.color;
            eventEl.title = evt.title;

            const dot = document.createElement('span');
            dot.className = 'h-1.5 w-1.5 flex-shrink-0 rounded-full';
            dot.style.backgroundColor = evt.color;
            eventEl.appendChild(dot);

            const label = document.createElement('span');
            label.className = 'truncate hidden sm:inline';
            label.textContent = evt.title;
            eventEl.appendChild(label);

            eventsContainer.appendChild(eventEl);
          }
        });

        if (dayEvents.length > 3) {
          const more = document.createElement('div');
          more.className = 'text-[10px] text-surface-400 px-1';
          more.textContent = `+${dayEvents.length - 3} more`;
          eventsContainer.appendChild(more);
        }

        cell.appendChild(eventsContainer);
      }
    }

    return cell;
  }

  // Navigation
  document.getElementById('prev-btn')?.addEventListener('click', () => {
    currentMonth--;
    if (currentMonth < 0) {
      currentMonth = 11;
      currentYear--;
    }
    renderCalendar();
  });

  document.getElementById('next-btn')?.addEventListener('click', () => {
    currentMonth++;
    if (currentMonth > 11) {
      currentMonth = 0;
      currentYear++;
    }
    renderCalendar();
  });

  document.getElementById('today-btn')?.addEventListener('click', () => {
    const now = new Date();
    currentYear = now.getFullYear();
    currentMonth = now.getMonth();
    renderCalendar();
  });

  // Initial render
  renderCalendar();
</script>
