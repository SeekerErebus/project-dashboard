---
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import tasks from '../../data/tasks.json';
import projects from '../../data/projects.json';

const projectMap = Object.fromEntries(projects.map((p) => [p.id, p]));

// Group tasks by project
interface TaskWithDates {
  id: string;
  title: string;
  project: string | null;
  priority: string;
  status: string;
  dueDate: string | null;
  startDate: string | null;
  description: string;
}

// Compute start dates for tasks based on project start dates and reasonable offsets
// Tasks without a project get a default start 5 days before due
function computeStartDate(task: typeof tasks[0]): string | null {
  if (!task.dueDate) return null;

  const proj = task.project ? projectMap[task.project] : null;
  if (proj && proj.startDate) {
    // Spread tasks within the project timeline
    const projStart = new Date(proj.startDate);
    const projEnd = new Date(proj.dueDate);
    const taskDue = new Date(task.dueDate);

    // Task start is midpoint between project start and task due date, capped
    const midpoint = new Date(projStart.getTime() + (taskDue.getTime() - projStart.getTime()) * 0.4);
    // Ensure start is at least 2 days before due
    const twoDaysBefore = new Date(taskDue);
    twoDaysBefore.setDate(twoDaysBefore.getDate() - 2);
    const start = midpoint < twoDaysBefore ? midpoint : twoDaysBefore;
    return start.toISOString().split('T')[0];
  }

  // Default: 5 days before due
  const due = new Date(task.dueDate);
  due.setDate(due.getDate() - 5);
  return due.toISOString().split('T')[0];
}

const enrichedTasks: TaskWithDates[] = tasks.map((t) => ({
  ...t,
  startDate: computeStartDate(t),
}));

// Build project groups, including an "Unassigned" group for tasks with no project
interface ProjectGroup {
  id: string;
  title: string;
  color: string;
  tasks: TaskWithDates[];
  startDate: string | null;
  dueDate: string | null;
}

const groupedMap = new Map<string, ProjectGroup>();

// Initialize project groups
projects.forEach((p) => {
  groupedMap.set(p.id, {
    id: p.id,
    title: p.title,
    color: p.color,
    tasks: [],
    startDate: p.startDate,
    dueDate: p.dueDate,
  });
});

// Add "Unassigned" group
groupedMap.set('unassigned', {
  id: 'unassigned',
  title: 'Unassigned',
  color: '#6b7280',
  tasks: [],
  startDate: null,
  dueDate: null,
});

// Distribute tasks
enrichedTasks.forEach((t) => {
  const groupId = t.project || 'unassigned';
  const group = groupedMap.get(groupId);
  if (group) {
    group.tasks.push(t);
  }
});

// Remove empty groups and sort by project start date
const projectGroups = Array.from(groupedMap.values())
  .filter((g) => g.tasks.length > 0)
  .sort((a, b) => {
    if (a.id === 'unassigned') return 1;
    if (b.id === 'unassigned') return -1;
    const dateA = a.startDate ? new Date(a.startDate).getTime() : Infinity;
    const dateB = b.startDate ? new Date(b.startDate).getTime() : Infinity;
    return dateA - dateB;
  });

// Sort tasks within each group by start date
projectGroups.forEach((g) => {
  g.tasks.sort((a, b) => {
    const da = a.startDate ? new Date(a.startDate).getTime() : Infinity;
    const db = b.startDate ? new Date(b.startDate).getTime() : Infinity;
    return da - db;
  });
});

// Compute the timeline range (earliest start to latest due, with padding)
let minDate = Infinity;
let maxDate = -Infinity;

enrichedTasks.forEach((t) => {
  if (t.startDate) minDate = Math.min(minDate, new Date(t.startDate).getTime());
  if (t.dueDate) maxDate = Math.max(maxDate, new Date(t.dueDate).getTime());
});

projects.forEach((p) => {
  if (p.startDate) minDate = Math.min(minDate, new Date(p.startDate).getTime());
  if (p.dueDate) maxDate = Math.max(maxDate, new Date(p.dueDate).getTime());
});

// Add padding: 3 days before and 5 days after
const MS_PER_DAY = 86400000;
const timelineStart = new Date(minDate - 3 * MS_PER_DAY);
const timelineEnd = new Date(maxDate + 5 * MS_PER_DAY);

// Generate week markers
interface WeekMarker {
  date: string;
  label: string;
  offsetPercent: number;
}

const totalDays = Math.ceil((timelineEnd.getTime() - timelineStart.getTime()) / MS_PER_DAY);

function getOffsetPercent(dateStr: string): number {
  const d = new Date(dateStr);
  const dayOffset = (d.getTime() - timelineStart.getTime()) / MS_PER_DAY;
  return (dayOffset / totalDays) * 100;
}

function getBarWidth(startStr: string, endStr: string): number {
  const s = new Date(startStr);
  const e = new Date(endStr);
  const days = Math.max(1, (e.getTime() - s.getTime()) / MS_PER_DAY);
  return (days / totalDays) * 100;
}

const weekMarkers: WeekMarker[] = [];
const cursor = new Date(timelineStart);
// Advance to next Monday
cursor.setDate(cursor.getDate() + ((8 - cursor.getDay()) % 7));
while (cursor <= timelineEnd) {
  const dateStr = cursor.toISOString().split('T')[0];
  weekMarkers.push({
    date: dateStr,
    label: cursor.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
    offsetPercent: getOffsetPercent(dateStr),
  });
  cursor.setDate(cursor.getDate() + 7);
}

// Today marker
const today = new Date();
today.setHours(0, 0, 0, 0);
const todayStr = today.toISOString().split('T')[0];
const todayPercent = getOffsetPercent(todayStr);
const todayInRange = todayPercent >= 0 && todayPercent <= 100;

// Status colors for bars
const statusBarColors: Record<string, { bg: string; border: string }> = {
  'done': { bg: 'bg-green-500/25', border: 'border-green-500/50' },
  'in-progress': { bg: 'bg-blue-500/25', border: 'border-blue-500/50' },
  'todo': { bg: 'bg-surface-500/20', border: 'border-surface-500/40' },
};

// Priority indicators
const priorityDots: Record<string, string> = {
  high: 'bg-red-500',
  medium: 'bg-amber-500',
  low: 'bg-blue-500',
};

const statusLabels: Record<string, string> = {
  'todo': 'To Do',
  'in-progress': 'In Progress',
  'done': 'Done',
};

const totalTasks = tasks.length;
const activeTasks = tasks.filter((t) => t.status !== 'done').length;

// Serialize data for client-side tooltip interaction
const ganttData = JSON.stringify(projectGroups);
---

<DashboardLayout title="Timeline" active="timeline">
  <!-- Header -->
  <div class="mb-6 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
    <div>
      <h1 class="text-2xl font-bold tracking-tight text-surface-100">Timeline</h1>
      <p class="mt-1 text-sm text-surface-400">
        {activeTasks} active tasks across {projectGroups.filter(g => g.id !== 'unassigned').length} projects
      </p>
    </div>
    <div class="flex items-center gap-3">
      <!-- Legend -->
      <div class="flex items-center gap-4 text-xs text-surface-400">
        <span class="flex items-center gap-1.5">
          <span class="inline-block h-3 w-8 rounded-sm border border-blue-500/50 bg-blue-500/25"></span>
          In Progress
        </span>
        <span class="flex items-center gap-1.5">
          <span class="inline-block h-3 w-8 rounded-sm border border-surface-500/40 bg-surface-500/20"></span>
          To Do
        </span>
        <span class="flex items-center gap-1.5">
          <span class="inline-block h-3 w-8 rounded-sm border border-green-500/50 bg-green-500/25"></span>
          Done
        </span>
      </div>
    </div>
  </div>

  <!-- Gantt Chart -->
  <div class="card overflow-hidden">
    <!-- Timeline Header with week markers -->
    <div class="gantt-container">
      <!-- Header row: labels column + timeline -->
      <div class="flex border-b border-surface-700/50">
        <!-- Label column header -->
        <div class="gantt-labels-col flex-shrink-0 border-r border-surface-700/50 bg-surface-900/60 px-4 py-3">
          <span class="text-[10px] font-semibold uppercase tracking-widest text-surface-500">Task</span>
        </div>
        <!-- Timeline header -->
        <div class="gantt-timeline-col relative flex-1 overflow-x-auto py-3">
          <div class="gantt-timeline-inner relative" style={`min-width: ${Math.max(800, totalDays * 12)}px;`}>
            {weekMarkers.map((wm) => (
              <div
                class="absolute top-0 text-[10px] font-medium text-surface-500"
                style={`left: ${wm.offsetPercent}%;`}
              >
                <span class="inline-block -translate-x-1/2">{wm.label}</span>
              </div>
            ))}
          </div>
        </div>
      </div>

      <!-- Project groups -->
      {projectGroups.map((group) => (
        <div class="gantt-group" data-group-id={group.id}>
          <!-- Project header row -->
          <div class="flex border-b border-surface-700/30 bg-surface-900/40">
            <div class="gantt-labels-col flex-shrink-0 border-r border-surface-700/50 px-4 py-2.5">
              <div class="flex items-center gap-2">
                <span class="h-2.5 w-2.5 rounded-sm flex-shrink-0" style={`background-color: ${group.color};`}></span>
                <span class="text-xs font-semibold text-surface-200 truncate">{group.title}</span>
                <span class="ml-auto rounded-md bg-surface-800 px-1.5 py-0.5 text-[10px] font-medium text-surface-500">
                  {group.tasks.length}
                </span>
              </div>
              {group.startDate && group.dueDate && (
                <div class="mt-1 text-[10px] text-surface-500">
                  {new Date(group.startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} &mdash; {new Date(group.dueDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                </div>
              )}
            </div>
            <!-- Project bar background -->
            <div class="gantt-timeline-col relative flex-1 overflow-x-auto">
              <div class="gantt-timeline-inner relative h-full" style={`min-width: ${Math.max(800, totalDays * 12)}px;`}>
                {/* Vertical grid lines */}
                {weekMarkers.map((wm) => (
                  <div
                    class="absolute inset-y-0 w-px bg-surface-700/20"
                    style={`left: ${wm.offsetPercent}%;`}
                  ></div>
                ))}
                {/* Project span bar */}
                {group.startDate && group.dueDate && (
                  <div
                    class="absolute top-1/2 -translate-y-1/2 h-2 rounded-full opacity-30"
                    style={`left: ${getOffsetPercent(group.startDate)}%; width: ${getBarWidth(group.startDate, group.dueDate)}%; background-color: ${group.color};`}
                  ></div>
                )}
                {/* Today line */}
                {todayInRange && (
                  <div
                    class="absolute inset-y-0 w-px bg-accent-500/50"
                    style={`left: ${todayPercent}%;`}
                  ></div>
                )}
              </div>
            </div>
          </div>

          <!-- Task rows -->
          {group.tasks.map((task) => {
            const barColors = statusBarColors[task.status] || statusBarColors['todo'];
            const hasRange = task.startDate && task.dueDate;
            return (
              <div class="gantt-row flex border-b border-surface-800/40 transition-colors hover:bg-surface-800/30" data-task-id={task.id}>
                <!-- Task label -->
                <div class="gantt-labels-col flex-shrink-0 border-r border-surface-700/50 px-4 py-2">
                  <div class="flex items-center gap-2">
                    <span class={`h-1.5 w-1.5 rounded-full flex-shrink-0 ${priorityDots[task.priority] || 'bg-surface-500'}`}></span>
                    <span class:list={[
                      'text-xs truncate max-w-[180px]',
                      task.status === 'done' ? 'text-surface-500 line-through' : 'text-surface-300',
                    ]}>{task.title}</span>
                  </div>
                  <div class="mt-0.5 flex items-center gap-2 pl-3.5">
                    <span class={`text-[10px] ${task.status === 'in-progress' ? 'text-blue-400' : task.status === 'done' ? 'text-green-400' : 'text-surface-500'}`}>
                      {statusLabels[task.status] || task.status}
                    </span>
                    {task.dueDate && (
                      <span class="text-[10px] text-surface-500">
                        Due {new Date(task.dueDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                      </span>
                    )}
                  </div>
                </div>
                <!-- Task bar -->
                <div class="gantt-timeline-col relative flex-1 overflow-x-auto">
                  <div class="gantt-timeline-inner relative h-full" style={`min-width: ${Math.max(800, totalDays * 12)}px;`}>
                    {/* Vertical grid lines */}
                    {weekMarkers.map((wm) => (
                      <div
                        class="absolute inset-y-0 w-px bg-surface-700/20"
                        style={`left: ${wm.offsetPercent}%;`}
                      ></div>
                    ))}
                    {/* Task bar */}
                    {hasRange && (
                      <div
                        class={`gantt-bar absolute top-1/2 -translate-y-1/2 h-6 rounded-md border ${barColors.bg} ${barColors.border} cursor-pointer transition-all hover:brightness-125 hover:shadow-lg`}
                        style={`left: ${getOffsetPercent(task.startDate!)}%; width: ${Math.max(0.8, getBarWidth(task.startDate!, task.dueDate!))}%;`}
                        data-task-title={task.title}
                        data-task-status={task.status}
                        data-task-priority={task.priority}
                        data-task-start={task.startDate}
                        data-task-due={task.dueDate}
                        data-task-description={task.description}
                      >
                        {/* Inner fill for progress indication on in-progress tasks */}
                        {task.status === 'in-progress' && (
                          <div class="absolute inset-y-0 left-0 rounded-l-md bg-blue-500/20 progress-shimmer" style="width: 60%;"></div>
                        )}
                        {task.status === 'done' && (
                          <div class="absolute inset-y-0 left-0 rounded-md bg-green-500/15" style="width: 100%;"></div>
                        )}
                        {/* Bar label (only if wide enough) */}
                        <span class="gantt-bar-label absolute inset-0 flex items-center px-2 text-[10px] font-medium text-surface-200 truncate pointer-events-none">
                          {task.title}
                        </span>
                      </div>
                    )}
                    {/* Due date diamond marker if no start date */}
                    {!hasRange && task.dueDate && (
                      <div
                        class="absolute top-1/2 -translate-y-1/2 -translate-x-1/2 h-3 w-3 rotate-45 rounded-sm border border-surface-500/50 bg-surface-500/30"
                        style={`left: ${getOffsetPercent(task.dueDate)}%;`}
                        title={`${task.title} - Due ${task.dueDate}`}
                      ></div>
                    )}
                    {/* Today line */}
                    {todayInRange && (
                      <div
                        class="absolute inset-y-0 w-px bg-accent-500/50"
                        style={`left: ${todayPercent}%;`}
                      ></div>
                    )}
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      ))}

      <!-- Today indicator label -->
      {todayInRange && (
        <div class="flex border-t border-surface-700/30">
          <div class="gantt-labels-col flex-shrink-0 border-r border-surface-700/50 px-4 py-1.5">
            <span class="text-[10px] font-medium text-accent-400">Today</span>
          </div>
          <div class="gantt-timeline-col relative flex-1 overflow-x-auto py-1.5">
            <div class="gantt-timeline-inner relative" style={`min-width: ${Math.max(800, totalDays * 12)}px;`}>
              <div
                class="absolute top-0 flex items-center"
                style={`left: ${todayPercent}%;`}
              >
                <div class="h-4 w-px bg-accent-500"></div>
                <span class="ml-1 text-[10px] font-medium text-accent-400">{today.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  </div>

  <!-- Tooltip -->
  <div id="gantt-tooltip" class="fixed z-[100] hidden max-w-xs rounded-lg border border-surface-700/50 bg-surface-900 px-4 py-3 shadow-2xl shadow-black/40 pointer-events-none">
    <p id="tooltip-title" class="text-sm font-semibold text-surface-100"></p>
    <div class="mt-1.5 flex items-center gap-3">
      <span id="tooltip-status" class="text-[11px] font-medium"></span>
      <span id="tooltip-priority" class="flex items-center gap-1 text-[11px] text-surface-400">
        <span id="tooltip-priority-dot" class="h-1.5 w-1.5 rounded-full"></span>
        <span id="tooltip-priority-text"></span>
      </span>
    </div>
    <div id="tooltip-dates" class="mt-1 text-[11px] text-surface-500"></div>
    <p id="tooltip-desc" class="mt-1.5 text-[11px] text-surface-400 leading-relaxed line-clamp-2"></p>
  </div>

  <!-- Summary cards at bottom -->
  <div class="mt-6 grid grid-cols-2 gap-4 sm:grid-cols-4">
    {projectGroups.filter(g => g.id !== 'unassigned').map((group) => {
      const doneTasks = group.tasks.filter(t => t.status === 'done').length;
      const progressPct = group.tasks.length > 0 ? Math.round((doneTasks / group.tasks.length) * 100) : 0;
      return (
        <div class="card-interactive p-4">
          <div class="flex items-center gap-2 mb-2">
            <span class="h-2.5 w-2.5 rounded-sm" style={`background-color: ${group.color};`}></span>
            <span class="text-xs font-semibold text-surface-200 truncate">{group.title}</span>
          </div>
          <div class="flex items-end justify-between">
            <div>
              <p class="text-lg font-bold text-surface-100">{doneTasks}/{group.tasks.length}</p>
              <p class="text-[10px] text-surface-500">tasks done</p>
            </div>
            <div class="text-right">
              <p class="text-sm font-semibold text-surface-300">{progressPct}%</p>
            </div>
          </div>
          <div class="mt-2 h-1.5 w-full rounded-full bg-surface-800">
            <div
              class="h-1.5 rounded-full transition-all duration-500 progress-shimmer"
              style={`width: ${progressPct}%; background-color: ${group.color};`}
            ></div>
          </div>
        </div>
      );
    })}
  </div>
</DashboardLayout>

<style>
  .gantt-labels-col {
    width: 240px;
    min-width: 240px;
  }

  @media (max-width: 640px) {
    .gantt-labels-col {
      width: 160px;
      min-width: 160px;
    }
  }

  .gantt-timeline-col {
    overflow-x: auto;
    overflow-y: hidden;
  }

  .gantt-timeline-inner {
    height: 100%;
    min-height: 28px;
  }

  .gantt-bar-label {
    opacity: 0;
    transition: opacity 0.15s ease;
  }

  .gantt-bar:hover .gantt-bar-label {
    opacity: 1;
  }

  /* Sync horizontal scroll across all timeline columns */
  .gantt-container {
    overflow: hidden;
  }

  /* Line clamp for tooltip description */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

<script>
  // ── Tooltip interaction for gantt bars ────────────────────────────────
  const tooltip = document.getElementById('gantt-tooltip');
  const tooltipTitle = document.getElementById('tooltip-title');
  const tooltipStatus = document.getElementById('tooltip-status');
  const tooltipPriorityDot = document.getElementById('tooltip-priority-dot');
  const tooltipPriorityText = document.getElementById('tooltip-priority-text');
  const tooltipDates = document.getElementById('tooltip-dates');
  const tooltipDesc = document.getElementById('tooltip-desc');

  const statusColors: Record<string, string> = {
    'todo': 'text-surface-500',
    'in-progress': 'text-blue-400',
    'done': 'text-green-400',
  };

  const statusLabels: Record<string, string> = {
    'todo': 'To Do',
    'in-progress': 'In Progress',
    'done': 'Done',
  };

  const priorityDotColors: Record<string, string> = {
    high: 'bg-red-500',
    medium: 'bg-amber-500',
    low: 'bg-blue-500',
  };

  function showTooltip(e: MouseEvent, bar: HTMLElement) {
    if (!tooltip) return;

    const title = bar.dataset.taskTitle || '';
    const status = bar.dataset.taskStatus || 'todo';
    const priority = bar.dataset.taskPriority || 'medium';
    const start = bar.dataset.taskStart || '';
    const due = bar.dataset.taskDue || '';
    const desc = bar.dataset.taskDescription || '';

    if (tooltipTitle) tooltipTitle.textContent = title;
    if (tooltipStatus) {
      tooltipStatus.textContent = statusLabels[status] || status;
      tooltipStatus.className = `text-[11px] font-medium ${statusColors[status] || 'text-surface-400'}`;
    }
    if (tooltipPriorityDot) {
      tooltipPriorityDot.className = `h-1.5 w-1.5 rounded-full ${priorityDotColors[priority] || 'bg-surface-500'}`;
    }
    if (tooltipPriorityText) {
      tooltipPriorityText.textContent = priority.charAt(0).toUpperCase() + priority.slice(1);
    }
    if (tooltipDates) {
      const startLabel = start ? new Date(start).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '?';
      const dueLabel = due ? new Date(due).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '?';
      tooltipDates.textContent = `${startLabel} \u2192 ${dueLabel}`;
    }
    if (tooltipDesc) {
      tooltipDesc.textContent = desc || 'No description.';
    }

    tooltip.classList.remove('hidden');
    positionTooltip(e);
  }

  function positionTooltip(e: MouseEvent) {
    if (!tooltip) return;
    const pad = 12;
    let x = e.clientX + pad;
    let y = e.clientY + pad;

    // Keep tooltip on screen
    const rect = tooltip.getBoundingClientRect();
    const vw = window.innerWidth;
    const vh = window.innerHeight;

    if (x + rect.width > vw - pad) x = e.clientX - rect.width - pad;
    if (y + rect.height > vh - pad) y = e.clientY - rect.height - pad;

    tooltip.style.left = `${x}px`;
    tooltip.style.top = `${y}px`;
  }

  function hideTooltip() {
    tooltip?.classList.add('hidden');
  }

  // Attach events
  document.querySelectorAll('.gantt-bar').forEach((bar) => {
    bar.addEventListener('mouseenter', (e) => showTooltip(e as MouseEvent, bar as HTMLElement));
    bar.addEventListener('mousemove', (e) => positionTooltip(e as MouseEvent));
    bar.addEventListener('mouseleave', hideTooltip);
  });

  // ── Synchronized horizontal scroll ─────────────────────────────────
  const timelineCols = document.querySelectorAll('.gantt-timeline-col');
  let scrolling = false;

  timelineCols.forEach((col) => {
    col.addEventListener('scroll', () => {
      if (scrolling) return;
      scrolling = true;
      const scrollLeft = col.scrollLeft;
      timelineCols.forEach((other) => {
        if (other !== col) {
          other.scrollLeft = scrollLeft;
        }
      });
      requestAnimationFrame(() => {
        scrolling = false;
      });
    });
  });
</script>
