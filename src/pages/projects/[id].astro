---
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import projects from '../../data/projects.json';
import clients from '../../data/clients.json';
import tasks from '../../data/tasks.json';

export function getStaticPaths() {
  return projects.map((project) => ({
    params: { id: project.id },
    props: { project },
  }));
}

const { project } = Astro.props;
const client = clients.find((c) => c.id === project.client);
const projectTasks = tasks.filter((t) => t.project === project.id);

function formatCurrency(amount: number) {
  return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount);
}

function formatDate(dateStr: string | null) {
  if (!dateStr) return 'TBD';
  return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function statusBadge(status: string) {
  switch (status) {
    case 'lead': return { label: 'Lead', classes: 'bg-surface-500/15 text-surface-400 ring-1 ring-surface-500/20' };
    case 'in-progress': return { label: 'In Progress', classes: 'bg-blue-500/15 text-blue-400 ring-1 ring-blue-500/20' };
    case 'review': return { label: 'Review', classes: 'bg-amber-500/15 text-amber-400 ring-1 ring-amber-500/20' };
    case 'completed': return { label: 'Completed', classes: 'bg-green-500/15 text-green-400 ring-1 ring-green-500/20' };
    default: return { label: status, classes: 'bg-surface-500/15 text-surface-400' };
  }
}

function priorityClasses(priority: string) {
  switch (priority) {
    case 'high': return 'bg-red-500/15 text-red-400';
    case 'medium': return 'bg-amber-500/15 text-amber-400';
    case 'low': return 'bg-blue-500/15 text-blue-400';
    default: return 'bg-surface-500/15 text-surface-400';
  }
}

const badge = statusBadge(project.status);
const budgetRemaining = project.budget - project.spent;
const budgetPercent = project.budget > 0 ? Math.round((project.spent / project.budget) * 100) : 0;

function daysRemaining(dateStr: string | null) {
  if (!dateStr) return null;
  const due = new Date(dateStr);
  const now = new Date();
  const diff = Math.ceil((due.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));
  return diff;
}

const daysLeft = daysRemaining(project.dueDate);

// Task stats
const doneTasks = projectTasks.filter(t => t.status === 'done').length;
const inProgressTasks = projectTasks.filter(t => t.status === 'in-progress').length;
---

<DashboardLayout title={project.title} active="projects">
  <!-- Back Link -->
  <a href="/projects/" class="mb-5 inline-flex items-center gap-1.5 text-sm text-surface-400 transition-colors hover:text-accent-400">
    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
    </svg>
    Back to Projects
  </a>

  <!-- Header -->
  <div class="mb-8 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
    <div>
      <div class="flex items-center gap-3">
        <div class="h-3 w-3 rounded-full" style={`background-color: ${project.color}`}></div>
        <h1 class="text-2xl font-bold tracking-tight text-surface-100">{project.title}</h1>
        <span class:list={['inline-flex items-center rounded-full px-2.5 py-1 text-xs font-semibold', badge.classes]}>
          {badge.label}
        </span>
      </div>
      {client && (
        <a href={`/clients/${client.id}/`} class="mt-2 inline-flex items-center gap-1.5 text-sm text-surface-400 transition-colors hover:text-accent-400">
          <svg class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
          </svg>
          {client.name}
        </a>
      )}
    </div>
    <div class="flex items-center gap-2">
      <button class="inline-flex items-center gap-2 rounded-lg border border-surface-700/60 bg-surface-800/80 px-4 py-2 text-sm font-medium text-surface-300 transition-all hover:border-surface-600 hover:text-surface-100 hover:bg-surface-800">
        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
        </svg>
        Edit
      </button>
    </div>
  </div>

  <!-- Two Column Layout -->
  <div class="grid gap-6 lg:grid-cols-3">
    <!-- Left Column (2/3) -->
    <div class="flex flex-col gap-6 lg:col-span-2">
      <!-- Description Card -->
      <div class="card p-5 sm:p-6">
        <h2 class="mb-3 text-xs font-semibold uppercase tracking-wider text-surface-500">Description</h2>
        <p class="text-sm leading-relaxed text-surface-300">{project.description}</p>
      </div>

      <!-- Scope Card -->
      <div class="card p-5 sm:p-6">
        <h2 class="mb-4 text-xs font-semibold uppercase tracking-wider text-surface-500">Scope</h2>
        <ul class="space-y-2.5">
          {project.scope.map((item, i) => {
            const isComplete = i < project.progress / (100 / project.scope.length);
            return (
              <li class="flex items-start gap-3 group/item">
                <span class:list={[
                  'mt-0.5 flex h-5 w-5 flex-shrink-0 items-center justify-center rounded-md border transition-colors',
                  isComplete
                    ? 'border-green-500/30 bg-green-500/15'
                    : 'border-surface-600/60 bg-surface-700/30',
                ]}>
                  {isComplete && (
                    <svg class="h-3 w-3 text-green-400" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
                    </svg>
                  )}
                </span>
                <span class:list={['text-sm leading-relaxed', isComplete ? 'text-surface-500 line-through' : 'text-surface-200']}>
                  {item}
                </span>
              </li>
            );
          })}
        </ul>
      </div>

      <!-- Tasks Card -->
      <div class="card p-5 sm:p-6">
        <div class="mb-4 flex items-center justify-between">
          <h2 class="text-xs font-semibold uppercase tracking-wider text-surface-500">Tasks</h2>
          <div class="flex items-center gap-3 text-xs text-surface-500">
            <span>{doneTasks} done</span>
            <span class="h-3 w-px bg-surface-700"></span>
            <span>{inProgressTasks} active</span>
            <span class="h-3 w-px bg-surface-700"></span>
            <span>{projectTasks.length} total</span>
          </div>
        </div>
        {projectTasks.length > 0 ? (
          <div class="space-y-2">
            {projectTasks.map((task) => (
              <div class:list={[
                'flex items-center gap-3 rounded-lg border p-3 transition-all duration-200',
                task.status === 'done'
                  ? 'border-surface-700/20 bg-surface-900/30 opacity-60'
                  : 'border-surface-700/40 bg-surface-900/50 hover:border-surface-600/50',
              ]}>
                {/* Status icon */}
                {task.status === 'done' ? (
                  <div class="flex h-6 w-6 flex-shrink-0 items-center justify-center rounded-full bg-green-500/15 ring-1 ring-green-500/20">
                    <svg class="h-3 w-3 text-green-400" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
                    </svg>
                  </div>
                ) : task.status === 'in-progress' ? (
                  <div class="flex h-6 w-6 flex-shrink-0 items-center justify-center rounded-full bg-blue-500/15 ring-1 ring-blue-500/20">
                    <div class="h-2 w-2 rounded-full bg-blue-400 pulse-dot" />
                  </div>
                ) : (
                  <div class="flex h-6 w-6 flex-shrink-0 items-center justify-center rounded-full bg-surface-700/50 ring-1 ring-surface-600/30">
                    <div class="h-2 w-2 rounded-full bg-surface-500" />
                  </div>
                )}

                {/* Task info */}
                <div class="flex-1 min-w-0">
                  <p class:list={['text-sm font-medium', task.status === 'done' ? 'text-surface-500 line-through' : 'text-surface-200']}>
                    {task.title}
                  </p>
                  <p class="mt-0.5 text-xs text-surface-500 line-clamp-1">{task.description}</p>
                </div>

                {/* Right side meta */}
                <div class="flex flex-shrink-0 items-center gap-2">
                  <span class:list={['inline-flex items-center rounded-full px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide', priorityClasses(task.priority)]}>
                    {task.priority}
                  </span>
                  <span class="text-xs text-surface-500">{task.dueDate ? new Date(task.dueDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : ''}</span>
                </div>
              </div>
            ))}
          </div>
        ) : (
          <p class="text-sm text-surface-500">No tasks yet.</p>
        )}
      </div>

      <!-- Notes Card -->
      {project.notes && (
        <div class="card p-5 sm:p-6">
          <h2 class="mb-3 text-xs font-semibold uppercase tracking-wider text-surface-500">Notes</h2>
          <p class="text-sm leading-relaxed text-surface-300">{project.notes}</p>
        </div>
      )}
    </div>

    <!-- Right Column (1/3) -->
    <div class="flex flex-col gap-6">
      <!-- Progress Card -->
      <div class="card p-6">
        <h2 class="mb-5 text-xs font-semibold uppercase tracking-wider text-surface-500">Progress</h2>
        <div class="flex flex-col items-center">
          {/* Circular progress */}
          <div class="relative h-28 w-28">
            <svg class="h-28 w-28 -rotate-90" viewBox="0 0 120 120">
              <circle cx="60" cy="60" r="52" fill="none" stroke="var(--color-surface-700)" stroke-width="7" opacity="0.5" />
              <circle
                cx="60" cy="60" r="52" fill="none"
                stroke={project.color}
                stroke-width="7"
                stroke-linecap="round"
                stroke-dasharray={`${2 * Math.PI * 52}`}
                stroke-dashoffset={`${2 * Math.PI * 52 * (1 - project.progress / 100)}`}
                style="filter: drop-shadow(0 0 6px currentColor); transition: stroke-dashoffset 0.5s ease;"
              />
            </svg>
            <div class="absolute inset-0 flex flex-col items-center justify-center">
              <span class="text-2xl font-bold text-surface-100">{project.progress}%</span>
            </div>
          </div>
          <p class="mt-3 text-xs text-surface-400">
            {project.progress === 100 ? 'Project complete' : project.progress === 0 ? 'Not started' : 'In progress'}
          </p>
        </div>
      </div>

      <!-- Budget Card -->
      <div class="card p-6">
        <h2 class="mb-4 text-xs font-semibold uppercase tracking-wider text-surface-500">Budget</h2>
        <div class="mb-2 flex items-baseline justify-between">
          <span class="text-2xl font-bold text-surface-100">{formatCurrency(project.spent)}</span>
          <span class="text-sm text-surface-400">of {formatCurrency(project.budget)}</span>
        </div>
        <div class="mb-3 h-2 w-full overflow-hidden rounded-full bg-surface-700/60">
          <div
            class:list={['h-full rounded-full progress-shimmer', budgetPercent > 90 ? 'bg-red-500' : budgetPercent > 70 ? 'bg-amber-500' : 'bg-accent-500']}
            style={`width: ${budgetPercent}%`}
          />
        </div>
        <div class="flex items-center justify-between text-xs">
          <span class="text-surface-400">{budgetPercent}% spent</span>
          <span class:list={['font-semibold', budgetRemaining < 0 ? 'text-red-400' : 'text-green-400']}>
            {formatCurrency(budgetRemaining)} remaining
          </span>
        </div>
      </div>

      <!-- Timeline Card -->
      <div class="card p-6">
        <h2 class="mb-4 text-xs font-semibold uppercase tracking-wider text-surface-500">Timeline</h2>
        <div class="space-y-3">
          <div class="flex items-center justify-between">
            <span class="flex items-center gap-2 text-xs text-surface-400">
              <span class="h-1.5 w-1.5 rounded-full bg-green-400"></span>
              Start Date
            </span>
            <span class="text-sm font-medium text-surface-200">{formatDate(project.startDate)}</span>
          </div>
          <div class="flex items-center justify-between">
            <span class="flex items-center gap-2 text-xs text-surface-400">
              <span class="h-1.5 w-1.5 rounded-full bg-red-400"></span>
              Due Date
            </span>
            <span class="text-sm font-medium text-surface-200">{formatDate(project.dueDate)}</span>
          </div>
          <div class="border-t border-surface-700/40 pt-3">
            <div class="flex items-center justify-between">
              <span class="text-xs text-surface-400">Time Remaining</span>
              {daysLeft !== null ? (
                <span class:list={['text-sm font-semibold', daysLeft < 0 ? 'text-red-400' : daysLeft <= 7 ? 'text-amber-400' : 'text-surface-200']}>
                  {daysLeft < 0 ? `${Math.abs(daysLeft)} days overdue` : daysLeft === 0 ? 'Due today' : `${daysLeft} days`}
                </span>
              ) : (
                <span class="text-sm text-surface-500">TBD</span>
              )}
            </div>
          </div>
        </div>
      </div>

      <!-- Client Card -->
      {client && (
        <div class="card p-6">
          <h2 class="mb-4 text-xs font-semibold uppercase tracking-wider text-surface-500">Client</h2>
          <div class="flex items-center gap-3 mb-4">
            <div class="flex h-10 w-10 items-center justify-center rounded-full bg-gradient-to-br from-accent-500/30 to-accent-700/30 ring-1 ring-accent-500/20 text-sm font-semibold text-accent-400">
              {client.avatar}
            </div>
            <div>
              <p class="text-sm font-medium text-surface-200">{client.contact}</p>
              <p class="text-xs text-surface-400">{client.name}</p>
            </div>
          </div>
          <div class="space-y-2.5">
            <a href={`mailto:${client.email}`} class="flex items-center gap-2.5 text-xs text-surface-400 transition-colors hover:text-accent-400">
              <svg class="h-3.5 w-3.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07-1.916V6.75" />
              </svg>
              {client.email}
            </a>
            <a href={`tel:${client.phone}`} class="flex items-center gap-2.5 text-xs text-surface-400 transition-colors hover:text-accent-400">
              <svg class="h-3.5 w-3.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 0 0 2.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 0 1-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 0 0-1.091-.852H4.5A2.25 2.25 0 0 0 2.25 4.5v2.25Z" />
              </svg>
              {client.phone}
            </a>
            <div class="flex items-center gap-2.5 text-xs text-surface-400">
              <svg class="h-3.5 w-3.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 21h16.5M4.5 3h15M5.25 3v18m13.5-18v18M9 6.75h1.5m-1.5 3h1.5m-1.5 3h1.5m3-6H15m-1.5 3H15m-1.5 3H15M9 21v-3.375c0-.621.504-1.125 1.125-1.125h3.75c.621 0 1.125.504 1.125 1.125V21" />
              </svg>
              {client.industry}
            </div>
          </div>
          <a href={`/clients/${client.id}/`} class="mt-4 flex items-center justify-center gap-1.5 rounded-lg border border-surface-700/40 py-2 text-xs font-medium text-accent-400 transition-all hover:border-accent-500/30 hover:bg-accent-600/5">
            View Client Details
            <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5 21 12m0 0-7.5 7.5M21 12H3" />
            </svg>
          </a>
        </div>
      )}
    </div>
  </div>
</DashboardLayout>
