---
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import projects from '../../data/projects.json';
import clients from '../../data/clients.json';

const columns = [
  { key: 'lead', label: 'Lead' },
  { key: 'in-progress', label: 'In Progress' },
  { key: 'review', label: 'Review' },
  { key: 'completed', label: 'Completed' },
];

const projectsByStatus = Object.fromEntries(
  columns.map((col) => [col.key, projects.filter((p) => p.status === col.key)])
);

function getClient(clientId: string) {
  return clients.find((c) => c.id === clientId);
}

function formatCurrency(amount: number) {
  return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(amount);
}

function formatDate(dateStr: string | null) {
  if (!dateStr) return 'TBD';
  return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function priorityClasses(priority: string) {
  switch (priority) {
    case 'high': return 'bg-red-500/15 text-red-400';
    case 'medium': return 'bg-amber-500/15 text-amber-400';
    case 'low': return 'bg-blue-500/15 text-blue-400';
    default: return 'bg-surface-500/15 text-surface-400';
  }
}

function columnHeaderColor(key: string) {
  switch (key) {
    case 'lead': return 'bg-surface-500';
    case 'in-progress': return 'bg-blue-500';
    case 'review': return 'bg-amber-500';
    case 'completed': return 'bg-green-500';
    default: return 'bg-surface-500';
  }
}
---

<DashboardLayout title="Projects" active="projects">
  <!-- Page Header -->
  <div class="mb-6 flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-bold text-surface-100">Projects</h1>
      <p class="mt-1 text-sm text-surface-400">{projects.length} total projects across all stages</p>
    </div>
    <button class="inline-flex items-center gap-2 rounded-lg bg-accent-600 px-4 py-2.5 text-sm font-medium text-white transition-colors hover:bg-accent-700">
      <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
      </svg>
      New Project
    </button>
  </div>

  <!-- Kanban Board -->
  <div class="flex gap-4 overflow-x-auto pb-4">
    {columns.map((col) => {
      const colProjects = projectsByStatus[col.key] || [];
      return (
        <div class="flex w-72 min-w-[280px] flex-shrink-0 flex-col">
          {/* Column Header */}
          <div class="mb-3 flex items-center gap-2.5">
            <span class:list={['h-2.5 w-2.5 rounded-full', columnHeaderColor(col.key)]} />
            <h2 class="text-sm font-semibold text-surface-200">{col.label}</h2>
            <span class="inline-flex h-5 min-w-[20px] items-center justify-center rounded-full bg-surface-800 px-1.5 text-xs font-medium text-surface-400">
              {colProjects.length}
            </span>
          </div>

          {/* Cards */}
          <div class="flex flex-col gap-3">
            {colProjects.map((project) => {
              const client = getClient(project.client);
              return (
                <a href={`/projects/${project.id}/`} class="group block overflow-hidden rounded-xl border border-surface-700/50 bg-surface-800 transition-all hover:border-surface-600 hover:shadow-lg hover:shadow-surface-950/50">
                  {/* Color Bar */}
                  <div class="h-1.5" style={`background-color: ${project.color}`} />

                  <div class="p-4">
                    {/* Client Name */}
                    {client && (
                      <p class="mb-1 text-xs font-medium text-surface-400">{client.name}</p>
                    )}

                    {/* Project Title */}
                    <h3 class="text-sm font-semibold text-surface-100 group-hover:text-accent-400 transition-colors">{project.title}</h3>

                    {/* Progress Bar */}
                    <div class="mt-3">
                      <div class="mb-1 flex items-center justify-between">
                        <span class="text-xs text-surface-400">Progress</span>
                        <span class="text-xs font-medium text-surface-300">{project.progress}%</span>
                      </div>
                      <div class="h-1.5 w-full overflow-hidden rounded-full bg-surface-700">
                        <div
                          class="h-full rounded-full transition-all"
                          style={`width: ${project.progress}%; background-color: ${project.color}`}
                        />
                      </div>
                    </div>

                    {/* Meta Row */}
                    <div class="mt-3 flex items-center justify-between">
                      {/* Due Date */}
                      <div class="flex items-center gap-1.5 text-xs text-surface-400">
                        <svg class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5" />
                        </svg>
                        {formatDate(project.dueDate)}
                      </div>

                      {/* Priority Badge */}
                      <span class:list={['inline-flex items-center rounded-full px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide', priorityClasses(project.priority)]}>
                        {project.priority}
                      </span>
                    </div>

                    {/* Budget */}
                    <div class="mt-2.5 flex items-center justify-between border-t border-surface-700/50 pt-2.5">
                      <span class="text-xs text-surface-400">Budget</span>
                      <span class="text-xs font-medium text-surface-300">
                        {formatCurrency(project.spent)} / {formatCurrency(project.budget)}
                      </span>
                    </div>
                  </div>
                </a>
              );
            })}

            {colProjects.length === 0 && (
              <div class="flex h-24 items-center justify-center rounded-xl border border-dashed border-surface-700/50 text-xs text-surface-500">
                No projects
              </div>
            )}
          </div>
        </div>
      );
    })}
  </div>
</DashboardLayout>
